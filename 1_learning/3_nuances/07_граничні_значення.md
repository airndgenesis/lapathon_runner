# Граничні значення з плаваючою комою

## Зміст

- [Симптоми](#симптоми)
- [Чому це відбувається](#чому-це-відбувається)
- [Небезпечні патерни](#небезпечні-патерни)
- [Безпечні практики](#безпечні-практики)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Резюме](#резюме)

---

## Симптоми

Коли ви працюєте з граничними значеннями (наприклад, межа 50), деякі тести можуть несподівано провалюватися:

- Порівняння `значення < 50` може давати неправильний результат для обчислених флоат-чисел
- Порівняння цілого числа з обчисленим флоат-результатом може працювати нестабільно
- Оператори `<` та `<=` можуть поводитися непередбачувано на межових значеннях
- Тести з значеннями 49, 50, 51 можуть давати несподівані результаті при складних обчисленнях

**Ключова ознака:** Ваш алгоритм працює коректно для більшості значень, але проваліється саме на граничних випадках (наприклад, тест з значенням рівно 50 дає неправильний результат).

---

## Чому це відбувається

### Проблема точності флоат-чисел

Числа з плаваючою комою в комп'ютерах представляються в двійковій системі, що призводить до помилок округлення:

```мавка
; Це може не дорівнювати точно 50.0
результат = 150 / 3
```

### Змішування типів

Коли ви порівнюєте ціле число (наприклад, `50`) з обчисленим флоатом (наприклад, `25 * 2.0`), можуть виникати проблеми з точністю на граничних значеннях.

### Обчислення в умовах

Виконання арифметики безпосередньо в умовному виразі збільшує ризик помилок:

```мавка
; РИЗИКОВАНО
якщо значення * 2.5 < 50
  ; ...
кінець
```

---

## Небезпечні патерни

### Патерн 1: Обчислення прямо в порівнянні

**Неправильно:**
```мавка
дія перевірка_межі(значення)
  якщо значення * 2.5 < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець
```

**Проблема:** Арифметика виконується прямо в умові, що може призвести до помилок округлення на граничних значеннях.

---

### Патерн 2: Неявне припущення про рівність

**Неправильно:**
```мавка
дія перевірка_половини(загальна_сума)
  половина = загальна_сума / 2
  якщо половина < 25
    вернути "мало"
  інакше
    вернути "багато"
  кінець
кінець
```

**Проблема:** Що відбувається, коли `половина` дорівнює рівно 25? Чи це "мало" чи "багато"? Неявна логіка може призвести до помилок.

---

### Патерн 3: Порівняння без роздумів про `<` vs `<=`

**Неправильно:**
```мавка
дія чи_достатньо(запаси)
  якщо запаси < 50
    вернути "недостатньо"
  інакше
    вернути "достатньо"
  кінець
кінець
```

**Проблема:** Чи 50 — це "недостатньо" чи "достатньо"? Використання `<` означає, що 50 вважається достатнім, але чи це ваш намір?

---

## Безпечні практики

### Практика 1: Обчислюйте в окремі змінні

**Правильно:**
```мавка
дія перевірка_межі(значення)
  результат = значення * 2.5
  якщо результат < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець
```

**Чому це працює:** Обчислення виконується окремо від порівняння, що знижує ризик помилок округлення.

---

### Практика 2: Явно обробляйте граничний випадок

**Правильно:**
```мавка
дія перевірка_половини(загальна_сума)
  половина = загальна_сума / 2
  
  якщо половина < 25
    вернути "мало"
  інакше
    якщо половина == 25
      вернути "точно на межі"
    інакше
      вернути "багато"
    кінець
  кінець
кінець
```

**Чому це працює:** Граничний випадок (`== 25`) обробляється явно, що робить логіку зрозумілою та передбачуваною.

---

### Практика 3: Свідомо обирайте `<` або `<=`

**Правильно:**
```мавка
дія чи_достатньо(запаси)
  ; Свідомо обираємо <: 50 вважається достатнім
  якщо запаси < 50
    вернути "недостатньо"
  інакше
    вернути "достатньо"
  кінець
кінець

дія чи_надлишок(запаси)
  ; Свідомо обираємо <=: 50 вважається нормою, 51+ — надлишок
  якщо запаси <= 50
    вернути "норма"
  інакше
    вернути "надлишок"
  кінець
кінець
```

**Чому це працює:** Ви чітко визначаєте, як обробляється граничне значення, що робить код зрозумілим і тестованим.

---

## Приклади тестування

### Тест 1: Базова межа з цілими числами

**Тестові значення:**
```мавка
дія перевірка_межі_цілі(значення)
  якщо значення < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець

друк("Тест 49")
друк(перевірка_межі_цілі(49))  ; Очікується: менше
друк("Тест 50")
друк(перевірка_межі_цілі(50))  ; Очікується: більше або дорівнює
друк("Тест 51")
друк(перевірка_межі_цілі(51))  ; Очікується: більше або дорівнює
```

**Золоте правило:** Завжди тестуйте три значення: одне менше межі, саму межу, і одне більше межі.

---

### Тест 2: Межа з обчисленнями (безпечно)

**Правильно:**
```мавка
дія перевірка_обчислена(значення)
  результат = значення * 2.5
  якщо результат < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець

друк("Тест 19.6 множимо на 2.5")
друк(перевірка_обчислена(19.6))  ; 19.6 * 2.5 = 49
друк("Тест 20.0 множимо на 2.5")
друк(перевірка_обчислена(20.0))  ; 20.0 * 2.5 = 50
друк("Тест 20.4 множимо на 2.5")
друк(перевірка_обчислена(20.4))  ; 20.4 * 2.5 = 51
```

---

### Тест 3: Ділення та межі

```мавка
дія перевірка_ділення(значення)
  результат = значення / 2
  якщо результат >= 25
    вернути "більше або дорівнює 25"
  інакше
    вернути "менше 25"
  кінець
кінець

друк("Тест 48 ділимо на 2")
друк(перевірка_ділення(48))  ; 48 / 2 = 24
друк("Тест 50 ділимо на 2")
друк(перевірка_ділення(50))  ; 50 / 2 = 25
друк("Тест 52 ділимо на 2")
друк(перевірка_ділення(52))  ; 52 / 2 = 26
```

---

### Тест 4: Порівняння `<` проти `<=`

```мавка
дія тест_менше(значення)
  якщо значення < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець

дія тест_менше_рівно(значення)
  якщо значення <= 50
    вернути "менше або дорівнює"
  інакше
    вернути "більше"
  кінець
кінець

друк("Оператор <")
друк("49")
друк(тест_менше(49))
друк("50")
друк(тест_менше(50))
друк("51")
друк(тест_менше(51))

друк("Оператор <=")
друк("49")
друк(тест_менше_рівно(49))
друк("50")
друк(тест_менше_рівно(50))
друк("51")
друк(тест_менше_рівно(51))
```

---

### Тест 5: Сценарій з алгоритму

```мавка
дія перевірка_запасів(банки)
  сума = 0
  перебрати банки як кількість
    сума = сума + кількість
  кінець
  
  якщо сума < 50
    вернути "мало"
  інакше
    вернути "достатньо"
  кінець
кінець

друк("Тест з сумою 49")
друк(перевірка_запасів([10, 10, 10, 19]))
друк("Тест з сумою 50")
друк(перевірка_запасів([10, 10, 15, 15]))
друк("Тест з сумою 51")
друк(перевірка_запасів([10, 10, 10, 21]))
```

---

### Тест 6: Рівність на межах

```мавка
дія перевірка_рівності(значення)
  межа = 50
  якщо значення == межа
    вернути "дорівнює межі"
  інакше
    якщо значення < межа
      вернути "менше межі"
    інакше
      вернути "більше межі"
    кінець
  кінець
кінець

друк("Тест рівності")
друк("49.99")
друк(перевірка_рівності(49.99))
друк("50.0")
друк(перевірка_рівності(50.0))
друк("50")
друк(перевірка_рівності(50))
друк("50.01")
друк(перевірка_рівності(50.01))
```

---

### Тест 7: Комплексний тест діапазону

```мавка
дія чи_в_діапазоні(значення, мін, макс)
  якщо значення < мін
    вернути "нижче діапазону"
  інакше
    якщо значення > макс
      вернути "вище діапазону"
    інакше
      вернути "в діапазоні"
    кінець
  кінець
кінець

друк("Діапазон від 10 до 50")
друк("9")
друк(чи_в_діапазоні(9, 10, 50))
друк("10")
друк(чи_в_діапазоні(10, 10, 50))
друк("30")
друк(чи_в_діапазоні(30, 10, 50))
друк("50")
друк(чи_в_діапазоні(50, 10, 50))
друк("51")
друк(чи_в_діапазоні(51, 10, 50))
```

---

## Верифікація

### Крок 1: Створіть тестовий файл

Створіть файл `/tmp/тест_граничні_значення.м`:

```мавка
дія тест_граничних_значень()
  друк("=== Тест 1: Базова межа ===")
  
  друк("Значення 49")
  якщо 49 < 50
    друк("✓ 49 < 50")
  інакше
    друк("✗ 49 < 50")
  кінець
  
  друк("Значення 50")
  якщо 50 < 50
    друк("✗ 50 < 50")
  інакше
    друк("✓ 50 >= 50")
  кінець
  
  друк("Значення 51")
  якщо 51 < 50
    друк("✗ 51 < 50")
  інакше
    друк("✓ 51 >= 50")
  кінець
  
  друк("=== Тест 2: Обчислені значення ===")
  
  результат_49 = 19.6 * 2.5
  друк("19.6 * 2.5 = 49")
  якщо результат_49 < 50
    друк("✓ результат < 50")
  інакше
    друк("✗ результат < 50")
  кінець
  
  результат_50 = 20.0 * 2.5
  друк("20.0 * 2.5 = 50")
  якщо результат_50 < 50
    друк("✗ результат < 50")
  інакше
    друк("✓ результат >= 50")
  кінець
  
  результат_51 = 20.4 * 2.5
  друк("20.4 * 2.5 = 51")
  якщо результат_51 < 50
    друк("✗ результат < 50")
  інакше
    друк("✓ результат >= 50")
  кінець
  
  друк("=== Тест 3: Оператори < та <= ===")
  
  друк("50 < 50")
  якщо 50 < 50
    друк("✗ дійсне (помилка)")
  інакше
    друк("✓ недійсне (правильно)")
  кінець
  
  друк("50 <= 50")
  якщо 50 <= 50
    друк("✓ дійсне (правильно)")
  інакше
    друк("✗ недійсне (помилка)")
  кінець
  
  друк("=== Усі тести завершені ===")
кінець

тест_граничних_значень()
```

### Крок 2: Запустіть тести

```bash
~/мавка /tmp/тест_граничні_значення.м
```

**Очікуваний результат:** Усі тести повинні показувати ✓ (успішно).

---

### Крок 3: Тест небезпечного патерну

Створіть файл `/tmp/тест_небезпечно.м`:

```мавка
дія небезпечна_функція(значення)
  ; НЕБЕЗПЕЧНО: обчислення в умові
  якщо значення * 2.5 < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець

дія безпечна_функція(значення)
  ; БЕЗПЕЧНО: обчислення в окремій змінній
  результат = значення * 2.5
  якщо результат < 50
    вернути "менше"
  інакше
    вернути "більше або дорівнює"
  кінець
кінець

друк("=== Порівняння патернів ===")
друк("Небезпечна функція з 20.0")
друк(небезпечна_функція(20.0))
друк("Безпечна функція з 20.0")
друк(безпечна_функція(20.0))
```

Запустіть:
```bash
~/мавка /tmp/тест_небезпечно.м
```

---

## Резюме

### Що потрібно пам'ятати

1. **Завжди тестуйте три граничні значення:** `межа - 1`, `межа`, `межа + 1`
2. **Обчислюйте в окремі змінні:** Не виконуйте арифметику прямо в умовах
3. **Свідомо обирайте оператор:** `<` чи `<=`? Подумайте, як має оброблятися граничне значення
4. **Явно обробляйте межі:** Якщо граничне значення має особливу логіку, обробляйте його окремо

---

### Золоті правила граничних значень

| Правило | Опис | Приклад |
|:--------|:-----|:--------|
| **Правило трьох** | Тестуйте три значення: менше, дорівнює, більше | `49, 50, 51` для межі 50 |
| **Правило окремої змінної** | Обчислюйте перед порівнянням | `x = a * b` потім `якщо x < ...` |
| **Правило свідомого оператора** | Вибирайте `<` чи `<=` обдумано | `< 50` означає що 50 — це "достатньо" |
| **Правило явності** | Обробляйте межу явно при потребі | `якщо x == 50` окремою гілкою |

---

### Що працює

- ✅ Обчислення в окремих змінних перед порівнянням
- ✅ Явна обробка граничних випадків
- ✅ Свідомий вибір між `<` та `<=`
- ✅ Тестування трьох граничних значень

### Що не працює

- ❌ Арифметика прямо в умовах (ризиковано)
- ❌ Неявні припущення про рівність
- ❌ Випадковий вибір `<` або `<=`
- ❌ Тестування тільки одного граничного значення

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [06. Обмеження Unicode](./06_unicode.md)

**Наступне обмеження:** [08. Операції зі списками](./08_списки.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Останнє оновлення: 1 січня 2026*
