# Математика в порівняннях — ненадійна

## Зміст

- [Симптоми](#симптоми)
- [Код, що НЕ працює](#код-що-не-працює)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: проміжні змінні](#рішення-проміжні-змінні)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Розширення правила](#розширення-правила)

---

## Симптоми

Коли ви виконуєте арифметичні операції **безпосередньо всередині умовного виразу**, можуть виникати такі проблеми:

1. **Помилки точності на граничних значеннях** — особливо при порівняннях `<=`, `>=`, `==` з числами з плаваючою комою

2. **Непередбачувані результати** — код може компілюватися і навіть працювати на простих прикладах, але давати неправильні відповіді на складних або граничних тестах

3. **Проблеми з типами** — особливо при діленні, де результат може бути float замість int

4. **Важкість налагодження** — коли помилка виникає, складно зрозуміти, де саме в складному виразі проблема

---

## Код, що НЕ працює

### Приклад 1: Множення в умові

```мавка
дія перевірити_добуток(а, б, поріг)
  якщо а * б < поріг
    вернути "менше"
  інакше
    вернути "більше або рівне"
  кінець
кінець
```

**Проблема:** Хоча такий код може компілюватися в деяких випадках, він **ненадійний** і може давати неправильні результати на граничних значеннях або в складних сценаріях. Краще завжди використовувати проміжні змінні.

---

### Приклад 2: Ділення в умові

```мавка
дія перевірити_середнє(загально, частин, мінімум)
  якщо загально / частин >= мінімум
    вернути "достатньо"
  інакше
    вернути "недостатньо"
  кінець
кінець
```

**Проблема:** Навіть якщо парсер приймає такий код, на граничних значеннях (наприклад, `100 / 5 == 20`) можуть виникати помилки через проблеми з типами та точністю.

---

### Приклад 3: Додавання в умові

```мавка
дія перевірити_суму(а, б, ліміт)
  якщо а + б > ліміт
    вернути "перевищено"
  інакше
    вернути "норма"
  кінець
кінець
```

**Проблема:** На перший погляд може працювати, але при граничних випадках (наприклад, `50 + 50 == 100`) поведінка може бути непередбачуваною.

---

## Чому це відбувається

### Технічна причина

Інтерпретатор Мавки має **обмежену надійність складних виразів** у контексті умовних операторів. Це пов'язано з декількома факторами:

1. **Проблеми з точністю:** Арифметичні операції (особливо ділення та множення) повертають числа з плаваючою точкою, які **важко точно порівнювати** з цілими числами через внутрішнє представлення. Наприклад, `100 / 3 * 3` може не дорівнювати рівно `100`.

2. **Складність налагодження:** Коли помилка виникає в складному виразі типу `(а + б) * ц / д < поріг`, дуже важко зрозуміти, на якому етапі обчислення виникла проблема.

3. **Варіативна поведінка:** Деякі комбінації операцій працюють надійно, інші дають збої на граничних значеннях або в специфічних сценаріях. Це робить код непередбачуваним.

4. **Проблеми з типами:** Мавка може неочевидно перетворювати типи під час обчислень, що призводить до неочікуваних результатів порівнянь.

---

## Рішення: проміжні змінні

**Золоте правило:** Завжди **обчислюйте арифметичні операції в окрему змінну**, а потім порівнюйте цю змінну.

### Патерн рішення

```мавка
; Неправильно:
якщо вираз_1 оператор вираз_2
  дія
кінець

; Правильно:
результат = вираз_1 оператор вираз_2
якщо результат порівняння значення
  дія
кінець
```

---

### Виправлений приклад 1: Множення

```мавка
дія перевірити_добуток(а, б, поріг)
  добуток = а * б
  якщо добуток < поріг
    вернути "менше"
  інакше
    вернути "більше або рівне"
  кінець
кінець
```

**Чому це працює:** Спочатку обчислюємо `а * б` в змінну `добуток`, а потім робимо просте порівняння `добуток < поріг`.

---

### Виправлений приклад 2: Ділення

```мавка
дія перевірити_середнє(загально, частин, мінімум)
  частка = загально / частин
  якщо частка >= мінімум
    вернути "достатньо"
  інакше
    вернути "недостатньо"
  кінець
кінець
```

**Додатковий захист:** При діленні завжди перевіряйте, що знаменник не дорівнює нулю:

```мавка
дія перевірити_середнє_безпечно(загально, частин, мінімум)
  якщо частин == 0
    вернути "помилка: ділення на нуль"
  кінець
  
  частка = загально / частин
  якщо частка >= мінімум
    вернути "достатньо"
  інакше
    вернути "недостатньо"
  кінець
кінець
```

---

### Виправлений приклад 3: Додавання

```мавка
дія перевірити_суму(а, б, ліміт)
  сума = а + б
  якщо сума > ліміт
    вернути "перевищено"
  інакше
    вернути "норма"
  кінець
кінець
```

---

## Приклади тестування

### Тест 1: Множення на граничних значеннях

**Неправильно:**
```мавка
дія тест_неправильно(а, б, поріг)
  якщо а * б < поріг
    вернути "менше"
  інакше
    вернути "більше або рівне"
  кінець
кінець
```

**Правильно:**
```мавка
дія тест_правильно(а, б, поріг)
  добуток = а * б
  якщо добуток < поріг
    вернути "менше"
  інакше
    вернути "більше або рівне"
  кінець
кінець

друк(тест_правильно(10, 10, 100))  ; більше або рівне (граничне)
друк(тест_правильно(10, 9, 100))   ; менше
друк(тест_правильно(10, 11, 100))  ; більше або рівне
```

**Очікуваний вивід:**
```
більше або рівне
менше
більше або рівне
```

---

### Тест 2: Ділення з перевіркою на нуль

**Правильно:**
```мавка
дія безпечне_ділення(числівник, знаменник, мінімум)
  якщо знаменник == 0
    вернути "помилка"
  кінець
  
  частка = числівник / знаменник
  якщо частка >= мінімум
    вернути "достатньо"
  інакше
    вернути "недостатньо"
  кінець
кінець

друк(безпечне_ділення(100, 5, 20))   ; достатньо (граничне: 100/5=20)
друк(безпечне_ділення(100, 6, 20))   ; недостатньо (16.67 < 20)
друк(безпечне_ділення(100, 0, 20))   ; помилка (ділення на нуль)
друк(безпечне_ділення(100, 4, 20))   ; достатньо (25 > 20)
```

**Очікуваний вивід:**
```
достатньо
недостатньо
помилка
достатньо
```

---

### Тест 3: Додавання та віднімання

**Правильно:**
```мавка
дія тест_додавання(а, б, ліміт)
  сума = а + б
  якщо сума > ліміт
    вернути "перевищено"
  інакше
    вернути "норма"
  кінець
кінець

дія тест_віднімання(початок, витрати, мінімум)
  залишок = початок - витрати
  якщо залишок < мінімум
    вернути "критично"
  інакше
    вернути "безпечно"
  кінець
кінець

друк(тест_додавання(50, 60, 100))      ; перевищено (110 > 100)
друк(тест_додавання(40, 60, 100))      ; норма (100 == 100)
друк(тест_віднімання(100, 80, 20))     ; безпечно (20 == 20)
друк(тест_віднімання(100, 85, 20))     ; критично (15 < 20)
```

**Очікуваний вивід:**
```
перевищено
норма
безпечно
критично
```

---

### Тест 4: Комбінація операцій

**Правильно:**
```мавка
дія обчислити_складний_вираз(а, б, ц, поріг)
  проміжний_результат = а + б
  фінальний_результат = проміжний_результат * ц
  
  якщо фінальний_результат <= поріг
    вернути "пройшло"
  інакше
    вернути "не пройшло"
  кінець
кінець

друк(обчислити_складний_вираз(5, 5, 10, 100))  ; пройшло ((5+5)*10=100)
друк(обчислити_складний_вираз(5, 5, 11, 100))  ; не пройшло ((5+5)*11=110)
друк(обчислити_складний_вираз(3, 7, 9, 90))    ; пройшло ((3+7)*9=90)
друк(обчислити_складний_вираз(3, 7, 10, 90))   ; не пройшло ((3+7)*10=100)
```

**Очікуваний вивід:**
```
пройшло
не пройшло
пройшло
не пройшло
```

---

### Тест 5: Ділення з дробовими результатами

**Правильно:**
```мавка
дія перевірити_середній_бал(загальні_бали, кількість_предметів, прохідний_бал)
  середній = загальні_бали / кількість_предметів
  
  якщо середній >= прохідний_бал
    вернути "склав"
  інакше
    вернути "не склав"
  кінець
кінець

друк(перевірити_середній_бал(150, 3, 50))   ; склав (150/3=50)
друк(перевірити_середній_бал(149, 3, 50))   ; не склав (149/3=49.67)
друк(перевірити_середній_бал(200, 4, 50))   ; склав (200/4=50)
друк(перевірити_середній_бал(199, 4, 50))   ; не склав (199/4=49.75)
```

**Очікуваний вивід:**
```
склав
не склав
склав
не склав
```

---

### Тест 6: Перевірка на граничні цілі числа

**Правильно:**
```мавка
дія перевірити_підсумок(продано, ціна, мета)
  виручка = продано * ціна
  
  якщо виручка >= мета
    вернути "план виконано"
  інакше
    вернути "план не виконано"
  кінець
кінець

друк(перевірити_підсумок(10, 100, 1000))   ; план виконано (граничне)
друк(перевірити_підсумок(9, 100, 1000))    ; план не виконано
друк(перевірити_підсумок(11, 100, 1000))   ; план виконано
друк(перевірити_підсумок(20, 50, 1000))    ; план виконано (граничне)
```

**Очікуваний вивід:**
```
план виконано
план не виконано
план виконано
план виконано
```

---

### Тест 7: Складна логіка з кількома проміжними змінними

**Правильно:**
```мавка
дія розрахувати_знижку(базова_ціна, відсоток_знижки, мінімальна_ціна)
  знижка = базова_ціна * відсоток_знижки
  знижка = знижка / 100
  фінальна_ціна = базова_ціна - знижка
  
  якщо фінальна_ціна < мінімальна_ціна
    вернути "ціна занадто низька"
  інакше
    вернути "ціна прийнятна"
  кінець
кінець

друк(розрахувати_знижку(1000, 20, 800))   ; ціна прийнятна (1000-200=800)
друк(розрахувати_знижку(1000, 25, 800))   ; ціна занадто низька (1000-250=750)
друк(розрахувати_знижку(500, 10, 450))    ; ціна прийнятна (500-50=450)
друк(розрахувати_знижку(500, 15, 450))    ; ціна занадто низька (500-75=425)
```

**Очікуваний вивід:**
```
ціна прийнятна
ціна занадто низька
ціна прийнятна
ціна занадто низька
```

---

## Верифікація

### Крок 1: Демонстрація потенційної проблеми

Створіть файл `/tmp/тест_математика_ризиковано.м`:

```мавка
дія тест_ризиковано(а, б, поріг)
  якщо а * б < поріг
    вернути "менше"
  інакше
    вернути "більше або рівне"
  кінець
кінець

друк(тест_ризиковано(10, 10, 100))
```

Запустіть:
```bash
~/мавка /tmp/тест_математика_ризиковано.м
```

**Можливий результат:** Код може працювати в простих випадках, але **ненадійний** для продакшн-коду. Краще уникати такого підходу.

---

### Крок 2: Тест правильного коду

Створіть файл `/tmp/тест_математика_добре.м`:

```мавка
дія тест_правильно(а, б, поріг)
  добуток = а * б
  якщо добуток < поріг
    вернути "менше"
  інакше
    вернути "більше або рівне"
  кінець
кінець

друк(тест_правильно(10, 10, 100))
друк(тест_правильно(10, 9, 100))
друк(тест_правильно(10, 11, 100))
```

Запустіть:
```bash
~/мавка /tmp/тест_математика_добре.м
```

**Очікуваний результат:**
```
більше або рівне
менше
більше або рівне
```

---

### Крок 3: Комплексний тест

Створіть файл `/tmp/тест_математика_комплексний.м`:

```мавка
дія тест_додавання(а, б, ліміт)
  сума = а + б
  якщо сума > ліміт
    вернути "перевищено"
  інакше
    вернути "норма"
  кінець
кінець

дія тест_віднімання(початок, витрати, мінімум)
  залишок = початок - витрати
  якщо залишок < мінімум
    вернути "критично"
  інакше
    вернути "безпечно"
  кінець
кінець

дія тест_комбінація(а, б, ц, поріг)
  проміжний = а + б
  результат = проміжний * ц
  якщо результат <= поріг
    вернути "пройшло"
  інакше
    вернути "не пройшло"
  кінець
кінець

друк("=== Тест додавання ===")
друк(тест_додавання(50, 60, 100))
друк(тест_додавання(40, 50, 100))

друк("=== Тест віднімання ===")
друк(тест_віднімання(100, 80, 20))
друк(тест_віднімання(100, 85, 20))

друк("=== Тест комбінації операцій ===")
друк(тест_комбінація(5, 5, 10, 100))
друк(тест_комбінація(5, 5, 11, 100))
```

Запустіть:
```bash
~/мавка /tmp/тест_математика_комплексний.м
```

**Очікуваний результат:**
```
=== Тест додавання ===
перевищено
норма
=== Тест віднімання ===
безпечно
критично
=== Тест комбінації операцій ===
пройшло
не пройшло
```

---

## Розширення правила

Це правило **не обмежується лише порівняннями**. Воно також застосовується до:

### 1. Математика в операторі `вернути`

**Неправильno:**
```мавка
дія розрахунок(а, б, ц)
  вернути а * б - ц
кінець
```

**Правильно:**
```мавка
дія розрахунок(а, б, ц)
  добуток = а * б
  результат = добуток - ц
  вернути результат
кінець
```

---

### 2. Порівняння у вкладених умовах

**Неправильно:**
```мавка
якщо умова_1
  якщо а * б > 100
    вернути "так"
  кінець
кінець
```

**Правильно:**
```мавка
добуток = а * б
перевірка = добуток > 100

якщо умова_1
  якщо перевірка
    вернути "так"
  кінець
кінець
```

**Пояснення:** Навіть прості порівняння у вкладених умовах можуть працювати ненадійно. Розбийте їх на окремі змінні.

---

### 3. Математика у циклах

**Неправильно:**
```мавка
перебрати масив як елемент
  якщо елемент * 2 > поріг
    друк(елемент)
  кінець
кінець
```

**Правильно:**
```мавка
перебрати масив як елемент
  подвоєний = елемент * 2
  якщо подвоєний > поріг
    друк(елемент)
  кінець
кінець
```

---

## Резюме

### Що не працює надійно
- Арифметика **безпосередньо в умовах**: `якщо а * б < 100` (може працювати, але ненадійно)
- Арифметика **в операторі вернути**: `вернути а * б - ц` (відомі проблеми в алгоритмах 142, 160)
- Складні вирази **у вкладених умовах** — можуть давати збої на граничних значеннях
- Порівняння результатів **ділення з плаваючою точкою** — проблеми з точністю

### Що працює
- **Проміжні змінні** для всіх арифметичних операцій
- **Прості порівняння** з одним ідентифікатором: `якщо добуток < 100`
- **Покрокове обчислення** складних виразів

### Золоте правило
**Завжди обчислюйте арифметичні операції в окрему змінну перед використанням у порівняннях або поверненнях.** Це найнадійніший спосіб уникнути проблем з точністю, типами та непередбачуваною поведінкою на граничних значеннях.

### Чому це важливо
Навіть якщо простий код типу `якщо а * б < 100` може компілюватися і працювати в базових сценаріях, використання проміжних змінних:
- **Покращує читабельність** — зрозуміліше, що саме обчислюється
- **Спрощує налагодження** — можна легко вивести проміжні значення
- **Запобігає помилкам** — уникає проблем з точністю та типами
- **Гарантує надійність** — працює стабільно на всіх тестових випадках

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [03. Синтаксис foreach-циклу](./03_синтаксис_циклу.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Останнє оновлення: 1 січня 2026*
