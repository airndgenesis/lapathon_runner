# Ранні повернення в циклах — ненадійні

## Зміст

- [Симптоми](#симптоми)
- [Код, що НЕ працює](#код-що-не-працює)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: патерн акумулятора](#рішення-патерн-акумулятора)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Оптимізація](#оптимізація-ранній-вихід-через-прапорець)

---

## Симптоми

Коли ви намагаєтеся використати `вернути` (return) безпосередньо всередині циклу `перебрати`, виникає runtime-помилка:

```
Помилка в файлі.м:X
Неможливо здійснити предмет.

Історія здійснення:
  назва_функції в файлі.м
```

**Важливо:** Код успішно компілюється, але падає під час виконання.

---

## Код, що НЕ працює

```мавка
дія знайти_перше_велике_число(список)
  перебрати список як число
    якщо число > 100
      вернути число
    кінець
  кінець
  вернути -1
кінець

числа = [10, 50, 150, 200]
друк(знайти_перше_велике_число(числа))
```

При запуску цього коду програма скомпілюється, але **під час виконання** видасть помилку "Неможливо здійснити предмет."

---

## Чому це відбувається

Інтерпретатор Мавки **не підтримує передчасний вихід з циклу через `вернути`**. Це пов'язано з тим, як реалізовано стек викликів та управління потоком виконання в циклі `перебрати`.

**Технічна деталь:** Оператор `вернути` працює коректно поза циклами, але всередині `перебрати` він намагається "здійснити" (виконати) щось, що порушує внутрішню логіку ітератора.

---

## Рішення: патерн акумулятора

Замість раннього повернення використовуйте **патерн акумулятора**:

### Три кроки патерну

1. **До циклу:** Ініціалізуйте змінну-прапорець або змінну-результат
2. **В циклі:** Оновлюйте цю змінну за умовою
3. **Після циклу:** Аналізуйте змінну і повертайте результат

### Правильна реалізація

```мавка
дія знайти_перше_велике_число(список)
  знайдено = недійсне
  результат = -1
  
  перебрати список як число
    якщо знайдено == недійсне
      якщо число > 100
        знайдено = дійсне
        результат = число
      кінець
    кінець
  кінець
  
  вернути результат
кінець

числа = [10, 50, 150, 200]
друк(знайти_перше_велике_число(числа))
```

**Результат:** `150`

---

## Приклади тестування

### Тест 1: Пошук значення (boolean)

**Неправильно:**
```мавка
дія чи_є_непарне(масив)
  перебрати масив як елемент
    якщо елемент % 2 == 1
      вернути дійсне
    кінець
  кінець
  вернути недійсне
кінець
```

**Правильно:**
```мавка
дія чи_є_непарне(масив)
  знайдено = недійсне
  
  перебрати масив як елемент
    якщо елемент % 2 == 1
      знайдено = дійсне
    кінець
  кінець
  
  якщо знайдено
    вернути дійсне
  інакше
    вернути недійсне
  кінець
кінець
```

**Тест:**
```мавка
друк(чи_є_непарне([2, 4, 6]))     ; недійсне
друк(чи_є_непарне([2, 3, 4]))     ; дійсне
друк(чи_є_непарне([1]))           ; дійсне
```

---

### Тест 2: Пошук індексу

**Неправильно:**
```мавка
дія знайти_індекс(список, значення)
  індекс = 0
  перебрати список як елемент
    якщо елемент == значення
      вернути індекс
    кінець
    індекс = індекс + 1
  кінець
  вернути -1
кінець
```

**Правильно:**
```мавка
дія знайти_індекс(список, значення)
  індекс = 0
  знайдено = недійсне
  знайдений_індекс = -1
  
  перебрати список як елемент
    якщо знайдено == недійсне
      якщо елемент == значення
        знайдено = дійсне
        знайдений_індекс = індекс
      кінець
    кінець
    індекс = індекс + 1
  кінець
  
  вернути знайдений_індекс
кінець
```

**Тест:**
```мавка
міста = ["Київ", "Львів", "Одеса", "Харків"]
друк(знайти_індекс(міста, "Одеса"))    ; 2
друк(знайти_індекс(міста, "Дніпро"))   ; -1
```

---

### Тест 3: Перше входження більше за поріг

**Неправильно:**
```мавка
дія перша_велика_температура(температури)
  перебрати температури як т
    якщо т > 30
      вернути "знайдено спеку"
    кінець
  кінець
  вернути "спеки не було"
кінець
```

**Правильно:**
```мавка
дія перша_велика_температура(температури)
  була_спека = недійсне
  
  перебрати температури як т
    якщо т > 30
      була_спека = дійсне
    кінець
  кінець
  
  якщо була_спека
    вернути "знайдено спеку"
  інакше
    вернути "спеки не було"
  кінець
кінець
```

**Тест:**
```мавка
друк(перша_велика_температура([15, 20, 25]))      ; "спеки не було"
друк(перша_велика_температура([15, 35, 25]))      ; "знайдено спеку"
```

---

### Тест 4: Пошук максимального значення з умовою

**Неправильно:**
```мавка
дія знайти_максимум_більше(масив, поріг)
  перебрати масив як елемент
    якщо елемент > поріг
      вернути елемент
    кінець
  кінець
  вернути -1
кінець
```

**Правильно:**
```мавка
дія знайти_максимум_більше(масив, поріг)
  знайдено = недійсне
  максимум = -1
  
  перебрати масив як елемент
    якщо елемент > поріг
      якщо знайдено == недійсне
        максимум = елемент
        знайдено = дійсне
      інакше
        якщо елемент > максимум
          максимум = елемент
        кінець
      кінець
    кінець
  кінець
  
  вернути максимум
кінець
```

**Тест:**
```мавка
числа = [10, 50, 30, 80, 20]
друк(знайти_максимум_більше(числа, 25))    ; 80
друк(знайти_максимум_більше(числа, 100))   ; -1
```

---

### Тест 5: Перевірка валідності всіх елементів

**Неправильно:**
```мавка
дія чи_всі_позитивні(масив)
  перебрати масив як елемент
    якщо елемент <= 0
      вернути недійсне
    кінець
  кінець
  вернути дійсне
кінець
```

**Правильно:**
```мавка
дія чи_всі_позитивні(масив)
  знайдено_негативне = недійсне
  
  перебрати масив як елемент
    якщо елемент <= 0
      знайдено_негативне = дійсне
    кінець
  кінець
  
  якщо знайдено_негативне
    вернути недійсне
  інакше
    вернути дійсне
  кінець
кінець
```

**Тест:**
```мавка
друк(чи_всі_позитивні([1, 2, 3]))        ; дійсне
друк(чи_всі_позитивні([1, -2, 3]))      ; недійсне
друк(чи_всі_позитивні([0, 1, 2]))       ; недійсне
```

---

## Верифікація

### Крок 1: Тест неправильного коду

Створіть тестовий файл `/tmp/тест_повернення.м`:

```мавка
дія пошук_неправильно(список)
  перебрати список як елемент
    якщо елемент > 50
      вернути "знайдено"
    кінець
  кінець
  вернути "не знайдено"
кінець

числа = [10, 20, 60, 70]
друк(пошук_неправильно(числа))
```

Запустіть:
```bash
~/мавка /tmp/тест_повернення.м
```

**Очікуваний результат:** Runtime помилка "Неможливо здійснити предмет."

---

### Крок 2: Тест правильного коду

Тепер виправте на патерн акумулятора:

```мавка
дія пошук_правильно(список)
  знайдено = недійсне
  
  перебрати список як елемент
    якщо елемент > 50
      знайдено = дійсне
    кінець
  кінець
  
  якщо знайдено
    вернути "знайдено"
  інакше
    вернути "не знайдено"
  кінець
кінець

числа = [10, 20, 60, 70]
друк(пошук_правильно(числа))

малі = [10, 20, 30]
друк(пошук_правильно(малі))
```

Запустіть:
```bash
~/мавка /tmp/тест_повернення.м
```

**Очікуваний результат:**
```
знайдено
не знайдено
```

---

### Крок 3: Комплексний тест (пошук індексу)

```мавка
дія знайти_індекс_правильно(список, значення)
  індекс = 0
  знайдено = недійсне
  знайдений_індекс = -1
  
  перебрати список як елемент
    якщо знайдено == недійсне
      якщо елемент == значення
        знайдено = дійсне
        знайдений_індекс = індекс
      кінець
    кінець
    індекс = індекс + 1
  кінець
  
  вернути знайдений_індекс
кінець

числа = [10, 20, 30, 40, 50]
друк(знайти_індекс_правильно(числа, 30))    ; 2
друк(знайти_індекс_правильно(числа, 99))    ; -1
друк(знайти_індекс_правильно(числа, 10))    ; 0
```

**Очікуваний результат:**
```
2
-1
0
```

---

## Оптимізація: ранній вихід через прапорець

Якщо вам потрібно зупинити обробку після знаходження елементу (для продуктивності), використовуйте перевірку прапорця на початку кожної ітерації:

```мавка
дія знайти_перше(список, поріг)
  знайдено = недійсне
  результат = -1
  
  перебрати список як елемент
    якщо знайдено == недійсне
      якщо елемент > поріг
        знайдено = дійсне
        результат = елемент
      кінець
    кінець
  кінець
  
  вернути результат
кінець
```

Перевірка `якщо знайдено == недійсне` на початку циклу забезпечує, що після знаходження елементу решта ітерацій не виконує зайвих операцій.

### Порівняння підходів

**Без оптимізації (обробляє всі елементи):**
```мавка
дія знайти_перше_неоптимізовано(список, поріг)
  знайдено = недійсне
  результат = -1
  
  перебрати список як елемент
    якщо елемент > поріг
      знайдено = дійсне
      результат = елемент
    кінець
  кінець
  
  вернути результат
кінець
```

**З оптимізацією (припиняє перевірки після знаходження):**
```мавка
дія знайти_перше_оптимізовано(список, поріг)
  знайдено = недійсне
  результат = -1
  
  перебрати список як елемент
    якщо знайдено == недійсне          ; ← Ранній вихід
      якщо елемент > поріг
        знайдено = дійсне
        результат = елемент
      кінець
    кінець
  кінець
  
  вернути результат
кінець
```

---

## Резюме

### Що не працює
- `вернути` безпосередньо всередині циклу `перебрати`
- Ранні повернення з циклу за будь-якої умови
- Код компілюється, але падає при виконанні

### Що працює
- Патерн акумулятора: прапорець + перевірка після циклу
- Збереження результату в змінну всередині циклу
- `вернути` після завершення циклу

### Золоте правило
**Ніколи не використовуйте `вернути` всередині циклу `перебрати`** — завжди використовуйте патерн акумулятора.

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [01. Оператор "та" (AND)](./01_оператор_та.md)

**Наступне обмеження:** [03. Синтаксис foreach-циклу](./03_синтаксис_циклу.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Останнє оновлення: 1 січня 2026*
