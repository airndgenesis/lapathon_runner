# Арифметика в операторі повернення — ненадійна

## Зміст

- [Симптоми](#симптоми)
- [Код, що може НЕ працювати](#код-що-може-не-працювати)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: проміжні змінні](#рішення-проміжні-змінні)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Коли це критично](#коли-це-критично)

---

## Симптоми

Коли ви виконуєте арифметичні операції безпосередньо в операторі `вернути`, результат може бути:

- ❌ Неправильним (відрізнятись від очікуваного)
- ❌ Непередбачуваним (змінюватись між запусками)
- ❌ Залежати від контексту (працювати в одних випадках, не працювати в інших)

**Це особливо небезпечно**, бо код може **іноді працювати**, а іноді — ні. Це робить баги важкими для виявлення.

---

## Код, що може НЕ працювати

### Випадок 1: Віднімання з діленням

```мавка
дія обчислити_залишок(літрів_води, кількість)
  вернути літрів_води - (кількість / 2)
кінець
```

**Проблема:** Вираз `літрів_води - (кількість / 2)` може дати неправильний результат.

---

### Випадок 2: Складна арифметика

```мавка
дія розрахувати_ціну(базова_ціна, кількість, знижка)
  вернути (базова_ціна * кількість) - (базова_ціна * знижка / 100)
кінець
```

**Проблема:** Багато операцій в одному виразі збільшують ймовірність помилки.

---

### Випадок 3: Арифметика в умовному поверненні

```мавка
дія днів_до_свята(поточний_день, день_свята)
  якщо поточний_день < день_свята
    вернути день_свята - поточний_день
  інакше
    вернути 365 - (поточний_день - день_свята)
  кінець
кінець
```

**Проблема:** Арифметика в `вернути` всередині умовних блоків особливо ненадійна.

---

## Чому це відбувається

Причина точно невідома, але можливі пояснення:

1. **Проблема з оптимізацією:** Компілятор може неправильно оптимізувати арифметичні вирази в контексті `вернути`
2. **Порядок операцій:** Інтерпретатор може порушувати правильний порядок обчислення
3. **Проблема з типами:** Можливі неявні перетворення типів (ціле ↔ дробове)
4. **Контекстна залежність:** Поведінка змінюється залежно від оточуючого коду

**Висновок:** Точна причина не ідентифікована, але баг підтверджено в алгоритмах 142 та 160.

---

## Рішення: проміжні змінні

**Золоте правило:** Завжди розбивайте складні арифметичні вирази на окремі змінні перед поверненням.

### Як виправити код

#### Було (ненадійно):
```мавка
дія обчислити_залишок(літрів_води, кількість)
  вернути літрів_води - (кількість / 2)
кінець
```

#### Стало (надійно):
```мавка
дія обчислити_залишок(літрів_води, кількість)
  половина = кількість / 2
  результат = літрів_води - половина
  вернути результат
кінець
```

---

### Загальний патерн

```мавка
; ПОГАНО: арифметика прямо в вернути
вернути (а + б) * ц - д / 2

; ДОБРЕ: розбиваємо на кроки
сума = а + б
добуток = сума * ц
половина = д / 2
результат = добуток - половина
вернути результат
```

---

## Приклади тестування

### Тест 1: Базова арифметика з діленням

**Ненадійний код:**
```мавка
дія розрахунок_води(літрів, зупинок)
  вернути літрів - (зупинок / 2)
кінець
```

**Надійний код:**
```мавка
дія розрахунок_води(літрів, зупинок)
  витрата = зупинок / 2
  залишок = літрів - витрата
  вернути залишок
кінець
```

**Тестові випадки:**
```
розрахунок_води(100, 10) → очікується 95
розрахунок_води(50, 20) → очікується 40
розрахунок_води(30, 6) → очікується 27
```

---

### Тест 2: Арифметика в умові

**Ненадійний код:**
```мавка
дія днів_до_краси(поточний_день)
  якщо поточний_день < 20
    вернути 20 - поточний_день
  інакше
    вернути 0
  кінець
кінець
```

**Надійний код:**
```мавка
дія днів_до_краси(поточний_день)
  якщо поточний_день < 20
    різниця = 20 - поточний_день
    вернути різниця
  інакше
    вернути 0
  кінець
кінець
```

**Тестові випадки:**
```
днів_до_краси(10) → очікується 10
днів_до_краси(15) → очікується 5
днів_до_краси(20) → очікується 0
днів_до_краси(25) → очікується 0
```

---

### Тест 3: Множинні операції

**Ненадійний код:**
```мавка
дія ціна_з_знижкою(ціна, кількість, відсоток)
  вернути ціна * кількість - (ціна * кількість * відсоток / 100)
кінець
```

**Надійний код:**
```мавка
дія ціна_з_знижкою(ціна, кількість, відсоток)
  повна_ціна = ціна * кількість
  знижка = повна_ціна * відсоток / 100
  результат = повна_ціна - знижка
  вернути результат
кінець
```

**Тестові випадки:**
```
ціна_з_знижкою(100, 3, 10) → очікується 270
ціна_з_знижкою(50, 5, 20) → очікується 200
ціна_з_знижкою(1000, 1, 5) → очікується 950
```

---

### Тест 4: Дробові числа

**Ненадійний код:**
```мавка
дія літрів_на_людину(загальна_кількість, людей)
  вернути загальна_кількість / людей - 0.5
кінець
```

**Надійний код:**
```мавка
дія літрів_на_людину(загальна_кількість, людей)
  на_одного = загальна_кількість / людей
  з_резервом = на_одного - 0.5
  вернути з_резервом
кінець
```

**Тестові випадки:**
```
літрів_на_людину(10, 3) → очікується ~2.83
літрів_на_людину(15, 4) → очікується 3.25
літрів_на_людину(20, 5) → очікується 3.5
```

---

### Тест 5: Вкладені дужки

**Ненадійний код:**
```мавка
дія складний_розрахунок(а, б, ц)
  вернути ((а + б) * ц) - (а / 2)
кінець
```

**Надійний код:**
```мавка
дія складний_розрахунок(а, б, ц)
  сума = а + б
  добуток = сума * ц
  половина = а / 2
  результат = добуток - половина
  вернути результат
кінець
```

**Тестові випадки:**
```
складний_розрахунок(10, 5, 3) → очікується 40
складний_розрахунок(20, 10, 2) → очікується 50
складний_розрахунок(8, 2, 5) → очікується 46
```

---

## Верифікація

### Крок 1: Створити тестовий файл

Створіть файл `/tmp/тест_арифметика_повернення.м`:

```мавка
дія ненадійний(літрів, зупинок)
  вернути літрів - (зупинок / 2)
кінець

дія надійний(літрів, зупинок)
  витрата = зупинок / 2
  залишок = літрів - витрата
  вернути залишок
кінець

друк("Ненадійний варіант:")
друк(ненадійний(100, 10))
друк(ненадійний(50, 20))
друк(ненадійний(30, 6))

друк("Надійний варіант:")
друк(надійний(100, 10))
друк(надійний(50, 20))
друк(надійний(30, 6))
```

---

### Крок 2: Запустити тест

```bash
~/мавка /tmp/тест_арифметика_повернення.м
```

---

### Крок 3: Порівняти результати

**Очікуваний вивід (обидва варіанти мають збігатись):**
```
Ненадійний варіант:
95
40
27
Надійний варіант:
95
40
27
```

**Якщо результати відрізняються** — це підтверджує баг.

**Якщо результати однакові** — баг може проявитись в іншому контексті або версії.

---

### Крок 4: Тест в умовах

Створіть файл `/tmp/тест_умова_арифметика.м`:

```мавка
дія ненадійний_умовний(день)
  якщо день < 20
    вернути 20 - день
  інакше
    вернути 0
  кінець
кінець

дія надійний_умовний(день)
  якщо день < 20
    різниця = 20 - день
    вернути різниця
  інакше
    вернути 0
  кінець
кінець

друк("Ненадійний:")
друк(ненадійний_умовний(10))
друк(ненадійний_умовний(15))

друк("Надійний:")
друк(надійний_умовний(10))
друк(надійний_умовний(15))
```

**Очікувані результати:**
```
Ненадійний:
10
5
Надійний:
10
5
```

---

## Коли це критично

### Високий ризик (обов'язково використовуйте проміжні змінні):

1. **Ділення в арифметиці:** `а - (б / 2)`
2. **Множинні операції:** `(а + б) * ц - д`
3. **Арифметика в умовах:** `якщо умова ... вернути а - б`
4. **Дробові числа:** Будь-які операції з float
5. **Критичні розрахунки:** Гроші, точні вимірювання

### Нижчий ризик (але краще все одно перестрахуватись):

1. **Проста арифметика:** `вернути а + б`
2. **Одна операція:** `вернути а * 2`
3. **Константи:** `вернути значення - 10`

---

## Резюме

### Що робити

✅ **Завжди використовуйте проміжні змінні** для складних виразів  
✅ **Розбивайте на кроки** — кожна операція в окрему змінну  
✅ **Давайте зрозумілі імена** змінним (не `х`, а `половина`, `результат`)  
✅ **Тестуйте обидва варіанти** — прямий та через змінні

### Чого не робити

❌ **Не пишіть складну арифметику** прямо в `вернути`  
❌ **Не покладайтесь** на "в мене працює" — баг може бути непередбачуваним  
❌ **Не ігноруйте** це правило — краще перестрахуватись

### Золоте правило

**Будь-яка арифметична операція (окрім найпростішої) має виконуватись у проміжній змінній перед поверненням.**

Краще написати 2-3 додаткові рядки коду, ніж годинами шукати баг у неправильних обчисленнях.

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [04. Інші нюанси](./04_інші_нюанси.md)

---

*Документ створено на основі досвіду розробки алгоритмів 142 та 160*  
*Останнє оновлення: 1 січня 2026*
