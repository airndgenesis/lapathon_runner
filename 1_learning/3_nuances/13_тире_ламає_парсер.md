# Тире ламає парсер (Em Dash Breaks Parser)

## Зміст

- [Симптоми](#симптоми)
- [Технічна причина](#технічна-причина)
- [UTF-8 байти: різниця між — і -](#utf-8-байти-різниця-між--і--)
- [Код, що НЕ працює](#код-що-не-працює)
- [Рішення: використовуйте ASCII дефіс](#рішення-використовуйте-ascii-дефіс)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Резюме](#резюме)

---

## Симптоми

Коли ви намагаєтеся використати **em dash** (довге тире `—`, символ U+2014) у будь-якому місці вашого коду Мавки — у рядках, коментарях або навіть змінних — парсер видає критичну помилку:

```
Помилка в файлі.м
Не вдалося перекодувати файл в код мавки.
```

Ця помилка з'являється **до** етапу парсингу синтаксису, тобто на рівні **кодування файлу**. Парсер Мавки (версія 0.124.1) не може обробити UTF-8 байти символу em dash.

---

## Технічна причина

### Що таке em dash?

**Em dash** (`—`) — це символ пунктуації, який часто використовується в українській типографіці для позначення пауз або додаткової інформації. Він довший за звичайний дефіс (`-`) та коротке тире (`–`).

### Чому парсер ламається?

Парсер Мавки версії 0.124.1 має **проблему з розпізнаванням UTF-8 послідовності** для символу em dash:
- **Em dash (—):** UTF-8 кодування = `e2 80 94` (3 байти)
- **Regular hyphen (-):** UTF-8 кодування = `2d` (1 байт)

Коли парсер зустрічає байти `e2 80 94`, він **не може їх декодувати** як валідний символ мови Мавка і видає помилку "Не вдалося перекодувати файл".

**Це не проблема UTF-8 загалом** — Мавка підтримує українські літери (які теж є мультибайтовими UTF-8 символами). Проблема саме в **конкретному символі U+2014**.

---

## UTF-8 байти: різниця між — і -

Давайте подивимося на точну різницю між символами:

| Символ | Назва | UTF-8 байти (hex) | Кількість байтів |
|--------|-------|-------------------|------------------|
| `—` | Em dash (довге тире) | `e2 80 94` | 3 |
| `-` | Hyphen-minus (дефіс) | `2d` | 1 |
| `–` | En dash (коротке тире) | `e2 80 93` | 3 |

**Важливо:** Символи виглядають схоже, але мають різне кодування!

Ви можете перевірити це в терміналі:
```bash
printf "—" | xxd -p  # Виведе: e28094
printf "-" | xxd -p  # Виведе: 2d
```

---

## Код, що НЕ працює

### Приклад 1: Em dash у рядку

```мавка
дія головна()
  друк("відкривай — обережно")
кінець

головна()
```

**Помилка:**
```
Помилка в /tmp/тест.м
Не вдалося перекодувати файл в код мавки.
```

---

### Приклад 2: Em dash у коментарі

```мавка
; Алгоритм — це послідовність кроків
дія головна()
  друк("тест")
кінець

головна()
```

**Помилка:** Та сама — навіть у коментарях em dash ламає парсер!

---

### Приклад 3: Em dash у змінній

```мавка
дія головна()
  опис = "меню — це список страв"
  друк(опис)
кінець

головна()
```

**Помилка:** Парсер ламається і тут.

---

### Приклад 4: Множинні em dash

```мавка
дія головна()
  друк("перше — друге — третє — четверте")
кінець

головна()
```

**Помилка:** Навіть якщо em dash зустрічається кілька разів, помилка завжди одна і та сама.

---

## Рішення: використовуйте ASCII дефіс

Замініть **всі em dash (`—`)** на **звичайний дефіс (`-`)** або **подвійний дефіс (`--`)**.

### Варіант 1: Одинарний дефіс (-)

```мавка
дія головна()
  друк("відкривай - обережно")
кінець

головна()
```

**Результат:**
```
відкривай - обережно
```

✅ **Працює коректно!**

---

### Варіант 2: Подвійний дефіс (--)

Якщо вам потрібно візуально імітувати довше тире:

```мавка
дія головна()
  друк("відкривай -- обережно")
кінець

головна()
```

**Результат:**
```
відкривай -- обережно
```

✅ **Працює коректно!**

---

### Варіант 3: Дефіс з пробілами

Для кращої читабельності можна додати пробіли:

```мавка
дія головна()
  друк("відкривай  -  обережно")
кінець

головна()
```

**Результат:**
```
відкривай  -  обережно
```

✅ **Працює коректно!**

---

## Приклади тестування

### Тест 1: Рядок з em dash (не працює)

Створіть файл `/tmp/тест_тире_зламане.м`:

```мавка
дія головна()
  друк("правило — завжди перевіряй")
кінець

головна()
```

Запустіть:
```bash
~/мавка /tmp/тест_тире_зламане.м
```

**Очікуваний результат:**
```
Помилка в /tmp/тест_тире_зламане.м
Не вдалося перекодувати файл в код мавки.
```

---

### Тест 2: Рядок з дефісом (працює)

Виправте файл, замінивши `—` на `-`:

```мавка
дія головна()
  друк("правило - завжди перевіряй")
кінець

головна()
```

Запустіть:
```bash
~/мавка /tmp/тест_тире_зламане.м
```

**Очікуваний результат:**
```
правило - завжди перевіряй
```

✅ **Працює!**

---

### Тест 3: Em dash у коментарі (не працює)

```мавка
; Важливо — це критична функція
дія головна()
  друк("тест")
кінець

головна()
```

**Результат:** Помилка "Не вдалося перекодувати файл".

---

### Тест 4: Дефіс у коментарі (працює)

```мавка
; Важливо - це критична функція
дія головна()
  друк("тест")
кінець

головна()
```

**Результат:**
```
тест
```

✅ **Працює!**

---

### Тест 5: Реальний приклад з алгоритму

**Неправильно (алгоритм 107):**
```мавка
дія класифікувати_дверний_звук(рівень_гучності)
  якщо рівень_гучності < 30
    вернути "відкривай — обережно"
  інакше
    вернути "треба злити воду"
  кінець
кінець

друк(класифікувати_дверний_звук(20))
```

**Помилка:** Не вдалося перекодувати файл.

---

**Правильно:**
```мавка
дія класифікувати_дверний_звук(рівень_гучності)
  якщо рівень_гучності < 30
    вернути "відкривай - обережно"
  інакше
    вернути "треба злити воду"
  кінець
кінець

друк(класифікувати_дверний_звук(20))
```

**Результат:**
```
відкривай - обережно
```

✅ **Працює!**

---

### Тест 6: Множинні em dash у одному рядку

**Неправильно:**
```мавка
дія головна()
  друк("перше — друге — третє — четверте")
кінець

головна()
```

**Помилка:** Не вдалося перекодувати файл.

---

**Правильно:**
```мавка
дія головна()
  друк("перше - друге - третє - четверте")
кінець

головна()
```

**Результат:**
```
перше - друге - третє - четверте
```

✅ **Працює!**

---

### Тест 7: Em dash у змінній та умові

**Неправильно:**
```мавка
дія головна()
  меню = "борщ — 50 грн"
  
  якщо меню != ""
    друк(меню)
  кінець
кінець

головна()
```

**Помилка:** Не вдалося перекодувати файл.

---

**Правильно:**
```мавка
дія головна()
  меню = "борщ - 50 грн"
  
  якщо меню != ""
    друк(меню)
  кінець
кінець

головна()
```

**Результат:**
```
борщ - 50 грн
```

✅ **Працює!**

---

## Верифікація

### Крок 1: Перевірте UTF-8 байти

Якщо ви не впевнені, який символ використовуєте, перевірте його байти:

```bash
# Створіть тестовий файл з вашим символом
printf "—" | xxd -p   # Якщо виведе e28094 — це em dash (ПОГАНО)
printf "-" | xxd -p   # Якщо виведе 2d — це дефіс (ДОБРЕ)
```

---

### Крок 2: Автоматична заміна у всіх файлах

Якщо у вас вже є файли з em dash, замініть їх автоматично:

```bash
# У macOS/Linux:
sed -i '' 's/—/-/g' /шлях/до/файлу.м

# Або для всіх файлів у теці:
find ./algorithms -name "*.м" -exec sed -i '' 's/—/-/g' {} +
```

**Увага:** Обов'язково зробіть резервну копію перед масовою заміною!

---

### Крок 3: Візуальна перевірка редактором

У деяких текстових редакторах (VS Code, Sublime Text) можна:
1. Відкрити пошук (Ctrl+F / Cmd+F)
2. Вставити em dash: `—`
3. Замінити на дефіс: `-`
4. Натиснути "Replace All"

---

### Крок 4: Перевірка компіляції

Після заміни запустіть свій файл:
```bash
~/мавка /tmp/ваш_файл.м
```

Якщо помилка "Не вдалося перекодувати файл" зникла — все виправлено!

---

## Резюме

### Що не працює
- ❌ Em dash (`—`, UTF-8: `e2 80 94`) в будь-якому місці коду
- ❌ Em dash у рядках (`"текст — текст"`)
- ❌ Em dash у коментарях (`; коментар — пояснення`)
- ❌ Em dash у змінних (`х = "значення — опис"`)

### Що працює
- ✅ Звичайний дефіс (`-`, UTF-8: `2d`)
- ✅ Подвійний дефіс (`--`) для імітації довгого тире
- ✅ Дефіс з пробілами (` - `) для читабельності

### Золоте правило
**Завжди використовуйте ASCII дефіс (`-`) замість em dash (`—`)** у коді Мавки. Парсер не підтримує символ U+2014 і видає помилку кодування.

### Чому це важливо?
Багато текстових редакторів та програм автоматично замінюють подвійний дефіс (`--`) на em dash (`—`) під час набору тексту (це називається "smart quotes" або "типографічні заміни"). Обов'язково вимкніть цю функцію або перевіряйте код перед запуском!

### Уражені алгоритми
У цьому проекті em dash виявлено у наступних алгоритмах:
- **107**: Класифікація дверних звуків
- **110**: Калькулятор "ну я ж казав"
- **111**: Передбачувач погоди за ознаками
- **120**: Аналізатор черг

**Усі ці алгоритми потребують заміни `—` на `-` у файлах `мавка.м`.**

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Останнє оновлення: 1 січня 2026*
