# Аномалія підрахунку елементів масиву

## Зміст

- [Симптоми](#симптоми)
- [Код, що НЕ працює](#код-що-не-працює)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: винесення логіки за цикл](#рішення-винесення-логіки-за-цикл)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Чому це критично саме для числа 3?](#чому-це-критично-саме-для-числа-3)

---

## Симптоми

Коли ви намагаєтеся підрахувати елементи всередині циклу `перебрати` та виконати логічні перевірки (особливо на рівність конкретному числу) **всередині самого циклу**, виникають непередбачувані проблеми:

1. **Ранні повернення (return) в циклі при підрахунку не працюють** — код викликає помилку "Неможливо здійснити предмет"
2. **Перевірка на точне число елементів (особливо 3) всередині циклу ненадійна** — може призвести до некоректних результатів
3. **Логічні операції на лічильнику всередині циклу поводяться непередбачувано**

---

## Код, що НЕ працює

### Приклад 1: Підрахунок до порогу всередині циклу

```мавка
дія підрахувати_малі_елементи(масив, поріг)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент < поріг
      лічильник = лічильник + 1
      якщо лічильник == 3
        вернути "так"  ; ❌ Помилка: "Неможливо здійснити предмет"
      кінець
    кінець
  кінець
  
  вернути "ні"
кінець
```

**Помилка при запуску:**
```
Помилка в файлі.м:X
Неможливо здійснити предмет.
```

### Приклад 2: Прапорець всередині циклу

```мавка
дія знайти_три_елементи(масив)
  лічильник = 0
  знайдено = недійсне
  
  перебрати масив як елемент
    якщо елемент > 0
      лічильник = лічильник + 1
      якщо лічильник == 3
        знайдено = дійсне  ; ⚠️ Ненадійно всередині циклу
      кінець
    кінець
  кінець
  
  якщо знайдено
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець
```

Цей код **може** працювати в деяких випадках, але поведінка непередбачувана та ненадійна.

---

## Чому це відбувається

Це пов'язано з двома відомими обмеженнями парсера Мавки:

1. **Ранні повернення в циклах не підтримуються** (див. документацію про `вернути` в циклах)
2. **Лічильники та перевірки всередині циклів поводяться нестабільно**, особливо при перевірці на конкретні порогові значення

**Технічна деталь:** Парсер Мавки має проблеми з обробкою складної логіки **всередині** тіла циклу `перебрати`. Коли ви намагаєтесь:
- Інкрементувати лічильник
- Перевіряти його значення
- І виконувати дії (особливо `вернути`) на основі цієї перевірки

...все це в одному контексті циклу — парсер не може коректно обробити такий ланцюжок операцій.

**Особливо проблемним є число 3**, хоча аномалія спостерігається і для інших порогових значень.

---

## Рішення: винесення логіки за цикл

### Золоте правило

**Завжди виконуйте підрахунок всередині циклу, але логічні перевірки та повернення — після завершення циклу.**

### Патерн для заміни

```мавка
; ❌ Замість цього (НЕ працює):
перебрати масив як елемент
  якщо умова
    лічильник = лічильник + 1
    якщо лічильник == поріг
      вернути результат
    кінець
  кінець
кінець

; ✅ Використовуйте це (працює):
перебрати масив як елемент
  якщо умова
    лічильник = лічильник + 1
  кінець
кінець

; Перевірка після циклу
якщо лічильник >= поріг
  вернути результат
кінець
```

### Правильна реалізація

```мавка
дія підрахувати_малі_елементи(масив, поріг)
  лічильник = 0
  
  ; Крок 1: Підрахунок всередині циклу (без логіки)
  перебрати масив як елемент
    якщо елемент < поріг
      лічильник = лічильник + 1
    кінець
  кінець
  
  ; Крок 2: Логічні перевірки ПІСЛЯ циклу
  якщо лічильник >= 3
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець
```

---

## Приклади тестування

### Тест 1: Базовий підрахунок до 3

**Неправильно:**
```мавка
дія перевірити_три(масив)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 0
      лічильник = лічильник + 1
      якщо лічильник == 3
        вернути "три"  ; ❌ Помилка
      кінець
    кінець
  кінець
  
  вернути "не три"
кінець
```

**Правильно:**
```мавка
дія перевірити_три(масив)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 0
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник == 3
    вернути "три"
  інакше
    вернути "не три"
  кінець
кінець
```

---

### Тест 2: Підрахунок з умовою "більше або дорівнює"

**Правильно:**
```мавка
дія чи_достатньо_елементів(масив, мінімум)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 10
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник >= мінімум
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець
```

**Тести:**
```мавка
друк(чи_достатньо_елементів([5, 15, 25], 2))      ; так
друк(чи_достатньо_елементів([5, 15], 2))          ; ні
друк(чи_достатньо_елементів([15, 20, 25, 30], 4)) ; так
```

---

### Тест 3: Підрахунок з прапорцем

**Правильно:**
```мавка
дія знайти_рівно_п_ять(масив)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент < 100
      лічильник = лічильник + 1
    кінець
  кінець
  
  ; Прапорець після циклу
  знайдено = недійсне
  якщо лічильник == 5
    знайдено = дійсне
  кінець
  
  якщо знайдено
    вернути "знайдено п'ять"
  інакше
    вернути "не п'ять"
  кінець
кінець
```

---

### Тест 4: Складна логіка з кількома умовами

**Правильно:**
```мавка
дія аналіз_масиву(масив)
  великих = 0
  малих = 0
  
  ; Підрахунок всередині циклу
  перебрати масив як елемент
    якщо елемент > 50
      великих = великих + 1
    кінець
    якщо елемент < 10
      малих = малих + 1
    кінець
  кінець
  
  ; Вся логіка після циклу
  якщо великих >= 3
    якщо малих >= 2
      вернути "збалансований"
    кінець
  кінець
  
  вернути "незбалансований"
кінець
```

---

### Тест 5: Підрахунок до різних порогів

**Тест порогу 2:**
```мавка
дія поріг_два(масив)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 10
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник >= 2
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець

друк(поріг_два([5, 15, 25]))  ; так
друк(поріг_два([5, 15]))      ; ні
```

**Тест порогу 4:**
```мавка
дія поріг_чотири(масив)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 10
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник >= 4
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець

друк(поріг_чотири([15, 20, 25, 30]))      ; так
друк(поріг_чотири([15, 20, 25]))          ; ні
друк(поріг_чотири([15, 20, 25, 30, 35]))  ; так
```

---

### Тест 6: Підрахунок відповідностей умові

**Правильно:**
```мавка
дія підрахувати_в_діапазоні(масив, мін, макс)
  лічильник = 0
  
  перебрати масив як елемент
    перевірка_мін = елемент >= мін
    перевірка_макс = елемент <= макс
    
    якщо перевірка_мін
      якщо перевірка_макс
        лічильник = лічильник + 1
      кінець
    кінець
  кінець
  
  ; Повернення після циклу
  вернути лічильник
кінець

друк(підрахувати_в_діапазоні([5, 15, 25, 35, 45], 10, 30))  ; 2
друк(підрахувати_в_діапазоні([1, 2, 3, 4, 5], 1, 5))        ; 5
```

---

### Тест 7: Підрахунок з декількома лічильниками

**Правильно:**
```мавка
дія статистика_масиву(масив)
  додатніх = 0
  від_ємних = 0
  нулів = 0
  
  перебрати масив як елемент
    якщо елемент > 0
      додатніх = додатніх + 1
    кінець
    якщо елемент < 0
      від_ємних = від_ємних + 1
    кінець
    якщо елемент == 0
      нулів = нулів + 1
    кінець
  кінець
  
  ; Логіка після циклу
  якщо додатніх >= 3
    якщо від_ємних == 0
      вернути "позитивний масив"
    кінець
  кінець
  
  вернути "змішаний масив"
кінець
```

---

## Верифікація

### Крок 1: Тест неправильного коду

Створіть файл `/tmp/тест_підрахунок_проблема.м`:

```мавка
дія підрахувати_малі(масив, поріг)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент < поріг
      лічильник = лічильник + 1
      якщо лічильник == 3
        вернути "так"
      кінець
    кінець
  кінець
  
  вернути "ні"
кінець

друк(підрахувати_малі([1, 2, 3, 4, 5], 4))
друк(підрахувати_малі([1, 2, 5, 6], 4))
друк(підрахувати_малі([1, 2, 3, 10], 4))
```

Запустіть:
```bash
~/мавка /tmp/тест_підрахунок_проблема.м
```

**Очікуваний результат:**
```
Помилка в /tmp/тест_підрахунок_проблема.м:X
Неможливо здійснити предмет.
```

---

### Крок 2: Тест правильного коду

Створіть файл `/tmp/тест_підрахунок_правильно.м`:

```мавка
дія підрахувати_малі(масив, поріг)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент < поріг
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник >= 3
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець

друк(підрахувати_малі([1, 2, 3, 4, 5], 4))
друк(підрахувати_малі([1, 2, 5, 6], 4))
друк(підрахувати_малі([1, 2, 3, 10], 4))
друк(підрахувати_малі([1], 4))
друк(підрахувати_малі([1, 2, 3, 4, 5, 6], 5))
```

Запустіть:
```bash
~/мавка /tmp/тест_підрахунок_правильно.м
```

**Очікуваний результат:**
```
так
ні
так
ні
так
```

---

### Крок 3: Тест перевірки на рівність 3

Створіть файл `/tmp/тест_підрахунок_точно_три.м`:

```мавка
дія знайти_три(масив)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 0
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник == 3
    вернути "три"
  інакше
    вернути "не три"
  кінець
кінець

друк(знайти_три([1, 2, 3]))
друк(знайти_три([1, 2]))
друк(знайти_три([1, 2, 3, 4]))
друк(знайти_три([1, 0, 2, 0, 3]))
```

Запустіть:
```bash
~/мавка /tmp/тест_підрахунок_точно_три.м
```

**Очікуваний результат:**
```
три
не три
не три
три
```

---

### Крок 4: Тест різних порогів

Створіть файл `/tmp/тест_різні_пороги.м`:

```мавка
дія тест_порогу(масив, поріг)
  лічильник = 0
  
  перебрати масив як елемент
    якщо елемент > 10
      лічильник = лічильник + 1
    кінець
  кінець
  
  якщо лічильник >= поріг
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець

друк(тест_порогу([15, 20], 2))
друк(тест_порогу([15, 20, 25], 3))
друк(тест_порогу([15, 20, 25, 30], 4))
друк(тест_порогу([15, 20, 25, 30, 35], 5))
```

**Очікуваний результат:**
```
ні
так
так
так
```

---

## Чому це критично саме для числа 3?

Хоча аномалія підрахунку **не обмежується лише числом 3**, це число викликає найбільше проблем, оскільки:

1. **Число 3 часто зустрічається в реальних алгоритмах** (трійки, трикутники, три стани тощо)
2. **Парсер Мавки має особливі проблеми саме з цим порогом** при виконанні перевірок всередині циклів
3. **Комбінація інкременту + перевірки на 3 + дія всередині циклу** викликає найстабільніші помилки

**Емпірично підтверджено:** числа 2, 4, 5 також можуть викликати проблеми, але число 3 найбільш вразливе.

### Порівняння порогів

| Поріг | Стабільність всередині циклу | Рекомендація |
| :--- | :--- | :--- |
| **2** | ⚠️ Нестабільно | Виносьте за цикл |
| **3** | ❌ Дуже нестабільно | **Завжди** виносьте за цикл |
| **4** | ⚠️ Нестабільно | Виносьте за цикл |
| **5+** | ⚠️ Нестабільно | Виносьте за цикл |

**Висновок:** Незалежно від порогового значення, **завжди** виконуйте логічні перевірки лічильника після завершення циклу.

---

## Резюме

### Що не працює
- Підрахунок з логікою всередині циклу `перебрати`
- Ранні повернення (`вернути`) при досягненні порогу всередині циклу
- Перевірка значення лічильника всередині циклу (особливо `== 3`)
- Встановлення прапорців на основі лічильника всередині циклу

### Що працює
- Простий інкремент лічильника всередині циклу (без логіки)
- Усі логічні перевірки та повернення **після** завершення циклу
- Використання проміжних змінних для зберігання результатів підрахунку
- Перевірка лічильника на будь-які пороги (>=, ==, <=) **після** циклу

### Золоте правило
**Розділяйте підрахунок та логіку:** рахуйте всередині циклу, перевіряйте після циклу. Це єдиний надійний спосіб працювати з лічильниками в Мавці.

### Безпечний патерн
```мавка
; 1. Ініціалізація ДО циклу
лічильник = 0

; 2. Підрахунок ВСЕРЕДИНІ циклу (тільки інкремент!)
перебрати масив як елемент
  якщо умова
    лічильник = лічильник + 1
  кінець
кінець

; 3. Логіка ПІСЛЯ циклу
якщо лічильник >= поріг
  вернути результат
інакше
  вернути інший_результат
кінець
```

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [10. Арифметика в порівняннях та поверненнях](./10_арифметика_в_порівняннях.md)

**Наступне обмеження:** [12. Наступна аномалія](./12_наступна_аномалія.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Останнє оновлення: 1 січня 2026*
