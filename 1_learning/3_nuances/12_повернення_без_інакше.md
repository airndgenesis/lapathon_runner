# Повернення без явного блоку інакше — непередбачувана поведінка

## Зміст

- [Симптоми](#симптоми)
- [Код, що може НЕ працювати](#код-що-може-не-працювати)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: явні блоки інакше](#рішення-явні-блоки-інакше)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Коли це критично](#коли-це-критично)

---

## Симптоми

Коли ви використовуєте умовне повернення з блоком `якщо`, за яким слідує безумовне повернення поза блоком, Мавка може повертати довільні числові значення (наприклад, 1, 2, 3) замість очікуваного рядка або правильного значення.

**Типова помилка:**
```
Очікували: "результат"
Отримали: 2
```

Це свідчить про витік внутрішнього стану парсера або некоректну обробку шляхів повернення.

---

## Код, що може НЕ працювати

### Приклад 1: Проста умова без інакше

```мавка
дія оцінка_товару(ціна)
  якщо ціна > 1000
    вернути "дорого"
  кінець
  
  вернути "дешево"  ; ⚠️ Може повернути 1, 2 або 3
кінець
```

При виклику `оцінка_товару(500)` функція **має** повернути `"дешево"`, але замість цього може повернути число `1` або `2`.

---

### Приклад 2: Складні вкладені умови

```мавка
дія категорія_студента(бали, відвідуваність)
  якщо бали >= 90
    якщо відвідуваність >= 80
      вернути "відмінник"
    кінець
  кінець
  
  вернути "звичайний студент"  ; ⚠️ Ненадійно
кінець
```

При виклику `категорія_студента(85, 75)` очікується `"звичайний студент"`, але може повернутися `3`.

---

### Приклад 3: Множинні послідовні перевірки

```мавка
дія рівень_температури(температура)
  якщо температура < 0
    вернути "мороз"
  кінець
  
  якщо температура < 15
    вернути "холодно"
  кінець
  
  якщо температура < 25
    вернути "комфортно"
  кінець
  
  вернути "спека"  ; ⚠️ Може працювати нестабільно
кінець
```

При певних крайових значеннях функція може повертати числа замість рядків.

---

## Чому це відбувається

Парсер Мавки **не завжди коректно обробляє шляхи виконання**, коли повернення знаходиться поза блоком `якщо-інакше`. У цьому випадку:

1. **Витік внутрішнього стану:** Парсер може витікати внутрішні лічильники або прапори (1, 2, 3), які використовуються для відстеження логіки виконання.
2. **Неявні шляхи повернення:** Коли немає явного блоку `інакше`, парсер може не розпізнати альтернативний шлях як валідне повернення.
3. **Проблеми з вкладеними блоками:** Особливо небезпечно при вкладених умовах, де кілька `якщо` не мають парних `інакше`.

**Технічна суть:** Це розширення загального правила "Implicit Returns Fail" (неявні повернення не працюють), але з унікальним симптомом — повернення малих цілих чисел.

---

## Рішення: явні блоки інакше

**Золоте правило:** Завжди використовуйте **явний блок `інакше`** для всіх умовних шляхів повернення.

### Виправлений приклад 1

```мавка
дія оцінка_товару(ціна)
  якщо ціна > 1000
    вернути "дорого"
  інакше
    вернути "дешево"  ; ✅ Працює надійно
  кінець
кінець
```

---

### Виправлений приклад 2

```мавка
дія категорія_студента(бали, відвідуваність)
  якщо бали >= 90
    якщо відвідуваність >= 80
      вернути "відмінник"
    інакше
      вернути "хорошист з низькою відвідуваністю"
    кінець
  інакше
    вернути "звичайний студент"  ; ✅ Надійно
  кінець
кінець
```

---

### Виправлений приклад 3: Ланцюг інакше-якщо

```мавка
дія рівень_температури(температура)
  якщо температура < 0
    вернути "мороз"
  інакше
    якщо температура < 15
      вернути "холодно"
    інакше
      якщо температура < 25
        вернути "комфортно"
      інакше
        вернути "спека"  ; ✅ Усі шляхи покриті
      кінець
    кінець
  кінець
кінець
```

---

## Приклади тестування

### Тест 1: Проста умова

**Неправильно:**
```мавка
дія перевірка_віку(вік)
  якщо вік >= 18
    вернути "дорослий"
  кінець
  
  вернути "дитина"
кінець
```

**Правильно:**
```мавка
дія перевірка_віку(вік)
  якщо вік >= 18
    вернути "дорослий"
  інакше
    вернути "дитина"
  кінець
кінець
```

---

### Тест 2: Вкладені умови

**Неправильно:**
```мавка
дія статус_замовлення(сума, клієнт_vip)
  якщо сума > 5000
    якщо клієнт_vip
      вернути "пріоритетне оброблення"
    кінець
  кінець
  
  вернути "звичайна черга"
кінець
```

**Правильно:**
```мавка
дія статус_замовлення(сума, клієнт_vip)
  якщо сума > 5000
    якщо клієнт_vip
      вернути "пріоритетне оброблення"
    інакше
      вернути "велике замовлення без vip"
    кінець
  інакше
    вернути "звичайна черга"
  кінець
кінець
```

---

### Тест 3: Діапазони значень

**Неправильно:**
```мавка
дія оцінка_швидкості(км_год)
  якщо км_год < 50
    вернути "повільно"
  кінець
  
  якщо км_год < 90
    вернути "нормально"
  кінець
  
  вернути "швидко"
кінець
```

**Правильно:**
```мавка
дія оцінка_швидкості(км_год)
  якщо км_год < 50
    вернути "повільно"
  інакше
    якщо км_год < 90
      вернути "нормально"
    інакше
      вернути "швидко"
    кінець
  кінець
кінець
```

---

### Тест 4: Повернення після циклу

**Неправильно:**
```мавка
дія перевірка_масиву(масив)
  сума = 0
  перебрати масив як елемент
    сума = сума + елемент
  кінець
  
  якщо сума > 100
    вернути "багато"
  кінець
  
  вернути "мало"  ; ⚠️ Може бути проблемою
кінець
```

**Правильно:**
```мавка
дія перевірка_масиву(масив)
  сума = 0
  перебрати масив як елемент
    сума = сума + елемент
  кінець
  
  якщо сума > 100
    вернути "багато"
  інакше
    вернути "мало"  ; ✅ Надійно
  кінець
кінець
```

---

### Тест 5: Булеві умови

**Неправильно:**
```мавка
дія чи_підходить(наявність, ціна_ок)
  якщо наявність
    якщо ціна_ок
      вернути "купуємо"
    кінець
  кінець
  
  вернути "пропускаємо"
кінець
```

**Правильно:**
```мавка
дія чи_підходить(наявність, ціна_ок)
  якщо наявність
    якщо ціна_ок
      вернути "купуємо"
    інакше
      вернути "дорого"
    кінець
  інакше
    вернути "немає в наявності"
  кінець
кінець
```

---

### Тест 6: Множинні рівні вкладеності

**Неправильно:**
```мавка
дія оцінка_проєкту(код, документація, тести)
  якщо код > 8
    якщо документація > 7
      якщо тести > 6
        вернути "відмінно"
      кінець
    кінець
  кінець
  
  вернути "потребує доопрацювання"
кінець
```

**Правильно:**
```мавка
дія оцінка_проєкту(код, документація, тести)
  якщо код > 8
    якщо документація > 7
      якщо тести > 6
        вернути "відмінно"
      інакше
        вернути "слабкі тести"
      кінець
    інакше
      вернути "слабка документація"
    кінець
  інакше
    вернути "потребує доопрацювання коду"
  кінець
кінець
```

---

### Тест 7: Поєднання з обчисленнями

**Неправильно:**
```мавка
дія рекомендація_поливу(вологість, температура)
  рівень = вологість * температура / 100
  
  якщо рівень > 50
    вернути "поливати не треба"
  кінець
  
  вернути "полийте рослини"
кінець
```

**Правильно:**
```мавка
дія рекомендація_поливу(вологість, температура)
  рівень = вологість * температура / 100
  
  якщо рівень > 50
    вернути "поливати не треба"
  інакше
    вернути "полийте рослини"
  кінець
кінець
```

---

## Верифікація

### Крок 1: Тест проблемного коду

Створіть файл `/tmp/тест_без_інакше.м`:

```мавка
дія тест(значення)
  якщо значення > 10
    вернути "велике"
  кінець
  
  вернути "мале"
кінець

друк(тест(15))
друк(тест(5))
```

Запустіть:
```bash
~/мавка /tmp/тест_без_інакше.м
```

**Можливий результат:**
```
велике
2
```

Або може працювати коректно — поведінка **непередбачувана**.

---

### Крок 2: Тест коректного коду

Виправте на явний блок `інакше`:

```мавка
дія тест(значення)
  якщо значення > 10
    вернути "велике"
  інакше
    вернути "мале"
  кінець
кінець

друк(тест(15))
друк(тест(5))
```

Запустіть:
```bash
~/мавка /tmp/тест_з_інакше.м
```

**Очікуваний результат:**
```
велике
мале
```

✅ **Працює стабільно.**

---

### Крок 3: Тест вкладених умов

Створіть файл `/tmp/тест_вкладені.м`:

```мавка
дія складний_тест(а, б)
  якщо а > 5
    якщо б > 10
      вернути "обидва великі"
    інакше
      вернути "а велике, б мале"
    кінець
  інакше
    вернути "а мале"
  кінець
кінець

друк(складний_тест(10, 15))
друк(складний_тест(10, 5))
друк(складний_тест(3, 15))
```

**Очікуваний результат:**
```
обидва великі
а велике, б мале
а мале
```

---

## Коли це критично

### Ситуації високого ризику:

1. **Функції з множинними умовами:** Кожна гілка має свій шлях повернення
2. **Вкладені блоки `якщо`:** Два і більше рівнів вкладеності без `інакше`
3. **Обчислення перед поверненням:** Коли результат розрахунків використовується для визначення шляху
4. **Робота з рядками:** Повернення рядкових значень особливо вразливе до витоку чисел
5. **Крайові випадки:** Граничні значення (0, 100, 1000) можуть тригерити помилку

---

## Резюме

### Що не працює надійно
- ❌ Повернення після закритого блоку `якщо` без парного `інакше`
- ❌ Множинні послідовні `якщо` з фінальним `вернути` поза блоками
- ❌ Вкладені `якщо` без повного покриття через `інакше`

### Що працює надійно
- ✅ Явні блоки `інакше` для кожного `якщо`
- ✅ Ланцюги `якщо-інакше-якщо-інакше`
- ✅ Вичерпне покриття всіх можливих шляхів виконання

### Золоте правило
**Кожен блок `якщо` з `вернути` має мати парний блок `інакше` з `вернути`** — це єдиний надійний спосіб уникнути витоку внутрішнього стану парсера.

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [11. Назви змінних - лише кирилиця](./11_лише_кирилиця.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Виявлено в алгоритмі 141 (Дніпровський розлив)*  
*Останнє оновлення: 1 січня 2026*
