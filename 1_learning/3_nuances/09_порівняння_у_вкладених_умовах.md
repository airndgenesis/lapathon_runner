# Порівняння у вкладених умовах — ненадійні на граничних значеннях

## Зміст

- [Симптоми](#симптоми)
- [Проблемний код](#проблемний-код)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: проміжні змінні для порівнянь](#рішення-проміжні-змінні-для-порівнянь)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Висновки та рекомендації](#висновки-та-рекомендації)

---

## Симптоми

Коли ви виконуєте порівняння **безпосередньо** всередині вкладених блоків `якщо` (особливо коли імітуєте логіку AND через вкладеність), алгоритм може давати **неправильні результати на граничних значеннях**.

Типові ознаки:
- Більшість тестів проходять успішно
- **Один або два тести з граничними значеннями** раптово падають
- Заміна порівняння на проміжну змінну — виправляє проблему
- Особливо проявляється при порівняннях з `> 0`, `>= 8`, `<= 10` тощо

**Критичність:** ⚠️ Середня — код компілюється, але дає неправильні результати у крайових випадках.

---

## Проблемний код

### Приклад 1: Порівняння з числовими константами

```мавка
дія перевірка_ремонту(тижнів_ремонту, годин_свердління_сьогодні)
  якщо тижнів_ремонту > 8
    якщо годин_свердління_сьогодні > 0  ; ❌ Може зламатися на граничному значенні
      вернути "критична ситуація"
    кінець
  кінець
  вернути "все нормально"
кінець

друк(перевірка_ремонту(9, 1))  ; Може дати неправильний результат
друк(перевірка_ремонту(8, 1))  ; Особливо на межі (8 vs 9)
```

**Що не так:**
- Порівняння `тижнів_ремонту > 8` та `годин_свердління_сьогодні > 0` виконуються **прямо в умовах**
- На граничних значеннях (8, 9, 0, 1) результат може бути непередбачуваним

---

### Приклад 2: Порівняння двох параметрів

```мавка
дія порівняти_показники(температура_зранку, температура_ввечері, тиск)
  якщо тиск > 750
    якщо температура_ввечері > температура_зранку  ; ❌ Ненадійно
      вернути "тепліше ввечері"
    кінець
  кінець
  вернути "холодніше або однаково"
кінець
```

**Що не так:**
- Вкладене порівняння між двома змінними
- Ризик помилок на рівних значеннях або дуже близьких числах

---

### Приклад 3: Потрійна вкладеність

```мавка
дія перевірка_складна(вік, стаж, зарплата)
  якщо вік > 30
    якщо стаж > 5
      якщо зарплата > 20000  ; ❌ Глибока вкладеність підвищує ризик
        вернути "відповідає"
      кінець
    кінець
  кінець
  вернути "не відповідає"
кінець
```

**Що не так:**
- Три рівні вкладених порівнянь
- Граничні значення (30, 5, 20000) — зона високого ризику

---

## Чому це відбувається

Парсер Мавки має внутрішні проблеми з **оцінкою виразів порівняння безпосередньо в контексті вкладених умов**. Це розширення відомого правила "Decouple Math from Comparisons" (відокремлюйте математику від порівнянь).

**Технічні причини:**
1. **Контекст вкладеності:** Коли порівняння виконується всередині блоку `якщо`, парсер може некоректно інтерпретувати результат
2. **Граничні значення:** Порівняння на межах діапазонів (8 vs 9, 0 vs 1) особливо вразливі
3. **Неявна типізація:** Можливі проблеми з приведенням типів у момент порівняння

**Важливо:** Це не проблема логіки — це проблема **парсера/інтерпретатора** Мавки.

---

## Рішення: проміжні змінні для порівнянь

### Золоте правило

**Завжди** обчислюйте результат порівняння в **окрему змінну**, а потім використовуйте цю змінну в умові.

---

### Виправлений приклад 1

```мавка
дія перевірка_ремонту(тижнів_ремонту, годин_свердління_сьогодні)
  ; ✅ Обчислюємо результати порівнянь заздалегідь
  перевірка_тижнів = тижнів_ремонту > 8
  перевірка_годин = годин_свердління_сьогодні > 0
  
  якщо перевірка_тижнів
    якщо перевірка_годин
      вернути "критична ситуація"
    кінець
  кінець
  вернути "все нормально"
кінець
```

**Переваги:**
- Результат порівняння обчислюється **до** входження в умову
- Парсер працює з готовим булевим значенням, а не з виразом
- Граничні значення обробляються коректно

---

### Виправлений приклад 2

```мавка
дія порівняти_показники(температура_зранку, температура_ввечері, тиск)
  перевірка_тиску = тиск > 750
  тепліше_ввечері = температура_ввечері > температура_зранку
  
  якщо перевірка_тиску
    якщо тепліше_ввечері
      вернути "тепліше ввечері"
    кінець
  кінець
  вернути "холодніше або однаково"
кінець
```

---

### Виправлений приклад 3

```мавка
дія перевірка_складна(вік, стаж, зарплата)
  відповідає_вік = вік > 30
  відповідає_стаж = стаж > 5
  відповідає_зарплата = зарплата > 20000
  
  якщо відповідає_вік
    якщо відповідає_стаж
      якщо відповідає_зарплата
        вернути "відповідає"
      кінець
    кінець
  кінець
  вернути "не відповідає"
кінець
```

---

## Приклади тестування

### Тест 1: Базове порівняння у вкладених умовах

**Проблемний код:**
```мавка
дія тест_базовий(тижні, години)
  якщо тижні > 8
    якщо години > 0
      вернути "критично"
    кінець
  кінець
  вернути "нормально"
кінець

друк(тест_базовий(9, 1))  ; Очікується: "критично"
друк(тест_базовий(8, 1))  ; Очікується: "нормально"
друк(тест_базовий(9, 0))  ; Очікується: "нормально"
```

**Правильний код:**
```мавка
дія тест_базовий(тижні, години)
  перевірка_тижнів = тижні > 8
  перевірка_годин = години > 0
  
  якщо перевірка_тижнів
    якщо перевірка_годин
      вернути "критично"
    кінець
  кінець
  вернути "нормально"
кінець

друк(тест_базовий(9, 1))  ; ✅ "критично"
друк(тест_базовий(8, 1))  ; ✅ "нормально"
друк(тест_базовий(9, 0))  ; ✅ "нормально"
```

---

### Тест 2: Порівняння двох змінних

**Проблемний код:**
```мавка
дія порівняння_температур(тижні, т_сьогодні, т_вчора)
  якщо тижні > 8
    якщо т_сьогодні > т_вчора  ; ❌ Пряме порівняння
      вернути "гарячіше"
    кінець
  кінець
  вернути "холодніше"
кінець
```

**Правильний код:**
```мавка
дія порівняння_температур(тижні, т_сьогодні, т_вчора)
  перевірка_тижнів = тижні > 8
  сьогодні_тепліше = т_сьогодні > т_вчора
  
  якщо перевірка_тижнів
    якщо сьогодні_тепліше
      вернути "гарячіше"
    кінець
  кінець
  вернути "холодніше"
кінець
```

---

### Тест 3: Комбінація з математикою

**Проблемний код:**
```мавка
дія тест_математика(годин_сьогодні, годин_вчора, дні)
  сума = годин_сьогодні + годин_вчора
  
  якщо дні > 7
    якщо сума > 16  ; ❌ Порівняння обчисленого значення
      вернути "перевантаження"
    кінець
  кінець
  вернути "норма"
кінець
```

**Правильний код:**
```мавка
дія тест_математика(годин_сьогодні, годин_вчора, дні)
  сума = годин_сьогодні + годин_вчора
  
  перевірка_днів = дні > 7
  перевищення_ліміту = сума > 16
  
  якщо перевірка_днів
    якщо перевищення_ліміту
      вернути "перевантаження"
    кінець
  кінець
  вернути "норма"
кінець
```

---

### Тест 4: Граничні значення з нулем

**Проблемний код:**
```мавка
дія перевірка_на_нуль(лічильник, значення)
  якщо лічильник >= 10
    якщо значення > 0  ; ❌ Порівняння з нулем у вкладеній умові
      вернути "активно"
    кінець
  кінець
  вернути "неактивно"
кінець

друк(перевірка_на_нуль(10, 1))  ; Очікується: "активно"
друк(перевірка_на_нуль(10, 0))  ; Очікується: "неактивно"
друк(перевірка_на_нуль(9, 1))   ; Очікується: "неактивно"
```

**Правильний код:**
```мавка
дія перевірка_на_нуль(лічильник, значення)
  достатньо_лічильника = лічильник >= 10
  значення_позитивне = значення > 0
  
  якщо достатньо_лічильника
    якщо значення_позитивне
      вернути "активно"
    кінець
  кінець
  вернути "неактивно"
кінець
```

---

### Тест 5: Діапазони значень

**Проблемний код:**
```мавка
дія у_діапазоні(мінімум, максимум, значення, активна)
  якщо активна
    якщо значення >= мінімум
      якщо значення <= максимум  ; ❌ Подвійна вкладеність з порівняннями
        вернути "в межах"
      кінець
    кінець
  кінець
  вернути "поза межами"
кінець
```

**Правильний код:**
```мавка
дія у_діапазоні(мінімум, максимум, значення, активна)
  більше_мінімуму = значення >= мінімум
  менше_максимуму = значення <= максимум
  
  якщо активна
    якщо більше_мінімуму
      якщо менше_максимуму
        вернути "в межах"
      кінець
    кінець
  кінець
  вернути "поза межами"
кінець
```

---

### Тест 6: Рівність на граничних значеннях

**Проблемний код:**
```мавка
дія перевірка_рівності(поріг, значення_1, значення_2)
  якщо поріг == 100
    якщо значення_1 == значення_2  ; ❌ Порівняння рівності
      вернути "рівні"
    кінець
  кінець
  вернути "різні"
кінець
```

**Правильний код:**
```мавка
дія перевірка_рівності(поріг, значення_1, значення_2)
  поріг_досягнуто = поріг == 100
  значення_рівні = значення_1 == значення_2
  
  якщо поріг_досягнуто
    якщо значення_рівні
      вернути "рівні"
    кінець
  кінець
  вернути "різні"
кінець
```

---

### Тест 7: Негативні числа та знаки

**Проблемний код:**
```мавка
дія аналіз_температури(днів, температура)
  якщо днів > 5
    якщо температура < 0  ; ❌ Порівняння з негативними
      вернути "мороз"
    кінець
  кінець
  вернути "тепло"
кінець
```

**Правильний код:**
```мавка
дія аналіз_температури(днів, температура)
  достатньо_днів = днів > 5
  нижче_нуля = температура < 0
  
  якщо достатньо_днів
    якщо нижче_нуля
      вернути "мороз"
    кінець
  кінець
  вернути "тепло"
кінець
```

---

## Верифікація

### Крок 1: Тест проблемного коду

Створіть файл `/tmp/тест_порівняння_прямі.м`:

```мавка
дія тест_прямі_порівняння(тижнів, годин)
  якщо тижнів > 8
    якщо годин > 0
      вернути "критично"
    кінець
  кінець
  вернути "нормально"
кінець

результат_1 = тест_прямі_порівняння(9, 1)
друк(результат_1)

результат_2 = тест_прямі_порівняння(8, 1)
друк(результат_2)

результат_3 = тест_прямі_порівняння(9, 0)
друк(результат_3)

результат_4 = тест_прямі_порівняння(10, 2)
друк(результат_4)

результат_5 = тест_прямі_порівняння(7, 5)
друк(результат_5)
```

Запустіть:
```bash
~/мавка /tmp/тест_порівняння_прямі.м
```

**Очікувані результати:**
```
критично
нормально
нормально
критично
нормально
```

**Можливі проблеми:** В деяких випадках (особливо в складніших алгоритмах) можуть бути неправильні результати на граничних значеннях.

---

### Крок 2: Тест виправленого коду

Створіть файл `/tmp/тест_порівняння_проміжні.м`:

```мавка
дія тест_проміжні_змінні(тижнів, годин)
  перевірка_тижнів = тижнів > 8
  перевірка_годин = годин > 0
  
  якщо перевірка_тижнів
    якщо перевірка_годин
      вернути "критично"
    кінець
  кінець
  вернути "нормально"
кінець

результат_1 = тест_проміжні_змінні(9, 1)
друк(результат_1)

результат_2 = тест_проміжні_змінні(8, 1)
друк(результат_2)

результат_3 = тест_проміжні_змінні(9, 0)
друк(результат_3)

результат_4 = тест_проміжні_змінні(10, 2)
друк(результат_4)

результат_5 = тест_проміжні_змінні(7, 5)
друк(результат_5)
```

Запустіть:
```bash
~/мавка /tmp/тест_порівняння_проміжні.м
```

**Очікувані результати (гарантовано правильні):**
```
критично
нормально
нормально
критично
нормально
```

---

### Крок 3: Тест із порівнянням двох змінних

Створіть файл `/tmp/тест_порівняння_змінних.м`:

```мавка
дія тест_з_порівнянням(тижні, година_сьогодні, година_вчора)
  перевірка_тижнів = тижні > 8
  сьогодні_більше = година_сьогодні > година_вчора
  
  якщо перевірка_тижнів
    якщо сьогодні_більше
      вернути "критично"
    кінець
  кінець
  вернути "нормально"
кінець

р1 = тест_з_порівнянням(9, 6, 5)
друк(р1)

р2 = тест_з_порівнянням(9, 5, 5)
друк(р2)

р3 = тест_з_порівнянням(9, 5, 6)
друк(р3)

р4 = тест_з_порівнянням(8, 10, 5)
друк(р4)
```

Запустіть:
```bash
~/мавка /tmp/тест_порівняння_змінних.м
```

**Очікувані результати:**
```
критично
нормально
нормально
нормально
```

---

## Висновки та рекомендації

### Що потрібно запам'ятати

1. **Порівняння у вкладених умовах — ненадійні:** Особливо на граничних значеннях (0, 1, 8, 9 тощо)
2. **Рішення — проміжні змінні:** Завжди обчислюйте результат порівняння в окрему змінну
3. **Це розширення правила "відокремлюй математику":** Раніше ми відокремлювали арифметику, тепер — і порівняння

---

### Патерн для заміни

```мавка
; ❌ Замість цього (ненадійно):
якщо умова_1 > значення_1
  якщо умова_2 > значення_2
    вернути "результат"
  кінець
кінець

; ✅ Використовуйте це (надійно):
перевірка_1 = умова_1 > значення_1
перевірка_2 = умова_2 > значення_2

якщо перевірка_1
  якщо перевірка_2
    вернути "результат"
  кінець
кінець
```

---

### Коли особливо важливо

- **Граничні значення:** Порівняння типу `> 0`, `>= 10`, `== 100`
- **Вкладені умови:** Два або більше рівнів вкладеності
- **Складні вирази:** Порівняння результатів обчислень
- **Критичні алгоритми:** Там, де помилка коштує дорого

---

### Золоте правило

**Завжди використовуйте проміжні змінні для порівнянь у вкладених умовах** — це єдиний гарантований спосіб уникнути проблем на граничних значеннях.

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [08. Інші особливості](./08_інші.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Виявлено під час роботи з алгоритмом 185*  
*Останнє оновлення: 1 січня 2026*
