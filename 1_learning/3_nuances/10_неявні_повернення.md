# Неявні повернення — небезпека мовчазних помилок

## Зміст

- [Симптоми](#симптоми)
- [Код, що НЕ працює очікувано](#код-що-не-працює-очікувано)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: вичерпні шляхи](#рішення-вичерпні-шляхи)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Резюме](#резюме)

---

## Симптоми

Коли ваша функція має ланцюг `якщо/якщо інакше`, але **не покриває всі можливі вхідні значення**, Мавка:

- **НЕ видає помилку** про відсутність повернення
- **НЕ попереджає** вас під час виконання
- **Мовчки повертає** `недійсне` (false/null)

Це призводить до **тихих логічних помилок**, які важко виявити.

**Приклад симптому:**
```
Очікували: "зима"
Отримали: недійсне
```

---

## Код, що НЕ працює очікувано

### Приклад 1: Класифікація чисел

```мавка
дія класифікувати_число(число)
  якщо число > 10
    вернути "велике"
  кінець
  
  якщо число < 0
    вернути "від'ємне"
  кінець
кінець

друк(класифікувати_число(5))  ; Очікуємо щось, отримуємо недійсне
```

**Проблема:** Числа від 0 до 10 не мають шляху повернення!

---

### Приклад 2: Оцінка балів

```мавка
дія оцінити_бали(бали)
  якщо бали >= 90
    вернути "відмінно"
  кінець
  
  якщо бали >= 70
    вернути "добре"
  кінець
  
  якщо бали >= 50
    вернути "задовільно"
  кінець
кінець

друк(оцінити_бали(30))  ; Очікуємо "незадовільно", отримуємо недійсне
```

**Проблема:** Бали нижче 50 не мають шляху повернення!

---

### Приклад 3: Визначення сезону

```мавка
дія знайти_сезон(місяць)
  якщо місяць >= 3
    якщо місяць <= 5
      вернути "весна"
    кінець
  кінець
  
  якщо місяць >= 6
    якщо місяць <= 8
      вернути "літо"
    кінець
  кінець
  
  якщо місяць >= 9
    якщо місяць <= 11
      вернути "осінь"
    кінець
  кінець
кінець

друк(знайти_сезон(12))  ; Очікуємо "зима", отримуємо недійсне
друк(знайти_сезон(1))   ; Очікуємо "зима", отримуємо недійсне
```

**Проблема:** Місяці 12, 1, 2 (зима) не мають шляху повернення!

---

## Чому це відбувається

У багатьох мовах програмування (TypeScript, Python, Rust) компілятор або інтерпретатор **аналізує шляхи виконання** і вимагає, щоб всі шляхи в функції повертали значення.

**В Мавці цього немає:**

1. **Немає аналізу потоку виконання** — парсер не перевіряє, чи всі гілки повертають значення
2. **Немає попереджень** — якщо функція не повертає явно, вона мовчки повертає `недійсне`
3. **Мовчазні помилки** — програма працює, але з неправильною логікою

**Технічна деталь:** Це схоже на поведінку JavaScript у режимі без `strict`, де функції без `return` повертають `undefined`.

---

## Рішення: вичерпні шляхи

Є два надійні патерни для вирішення цієї проблеми:

### Патерн 1: Завершальне `вернути`

Завжди додавайте **безумовне повернення** в кінці функції як страхувальну мережу:

```мавка
дія класифікувати_число(число)
  якщо число > 10
    вернути "велике"
  кінець
  
  якщо число < 0
    вернути "від'ємне"
  кінець
  
  вернути "нормальне"  ; Страхувальна мережа для всіх інших випадків
кінець
```

---

### Патерн 2: Повний ланцюг `якщо...інакше`

Використовуйте повний ланцюг з **обов'язковим `інакше`** в кінці:

```мавка
дія оцінити_бали(бали)
  якщо бали >= 90
    вернути "відмінно"
  інакше
    якщо бали >= 70
      вернути "добре"
    інакше
      якщо бали >= 50
        вернути "задовільно"
      інакше
        вернути "незадовільно"  ; Обов'язковий інакше!
      кінець
    кінець
  кінець
кінець
```

---

### Патерн 3: Комбінований підхід

Для складних випадків комбінуйте обидва підходи:

```мавка
дія знайти_сезон(місяць)
  якщо місяць >= 3
    якщо місяць <= 5
      вернути "весна"
    кінець
  кінець
  
  якщо місяць >= 6
    якщо місяць <= 8
      вернути "літо"
    кінець
  кінець
  
  якщо місяць >= 9
    якщо місяць <= 11
      вернути "осінь"
    кінець
  кінець
  
  вернути "зима"  ; Страхувальна мережа
кінець
```

---

## Приклади тестування

### Тест 1: Класифікація чисел (виправлено)

```мавка
дія класифікувати_число(число)
  якщо число > 10
    вернути "велике"
  кінець
  
  якщо число < 0
    вернути "від'ємне"
  кінець
  
  вернути "нормальне"
кінець

друк(класифікувати_число(15))   ; велике
друк(класифікувати_число(-5))   ; від'ємне
друк(класифікувати_число(5))    ; нормальне
друк(класифікувати_число(0))    ; нормальне
```

---

### Тест 2: Оцінка балів (з повним інакше)

```мавка
дія оцінити_бали(бали)
  якщо бали >= 90
    вернути "відмінно"
  інакше
    якщо бали >= 70
      вернути "добре"
    інакше
      якщо бали >= 50
        вернути "задовільно"
      інакше
        вернути "незадовільно"
      кінець
    кінець
  кінець
кінець

друк(оцінити_бали(95))   ; відмінно
друк(оцінити_бали(75))   ; добре
друк(оцінити_бали(55))   ; задовільно
друк(оцінити_бали(30))   ; незадовільно
друк(оцінити_бали(0))    ; незадовільно
```

---

### Тест 3: Визначення дня тижня

```мавка
дія назва_дня(номер)
  якщо номер == 1
    вернути "понеділок"
  кінець
  
  якщо номер == 2
    вернути "вівторок"
  кінець
  
  якщо номер == 3
    вернути "середа"
  кінець
  
  якщо номер == 4
    вернути "четвер"
  кінець
  
  якщо номер == 5
    вернути "п'ятниця"
  кінець
  
  якщо номер == 6
    вернути "субота"
  кінець
  
  якщо номер == 7
    вернути "неділя"
  кінець
  
  вернути "невірний номер дня"
кінець

друк(назва_дня(1))    ; понеділок
друк(назва_дня(5))    ; п'ятниця
друк(назва_дня(7))    ; неділя
друк(назва_дня(0))    ; невірний номер дня
друк(назва_дня(10))   ; невірний номер дня
```

---

### Тест 4: Перевірка віку для різних категорій

```мавка
дія категорія_віку(вік)
  якщо вік < 0
    вернути "помилка: негативний вік"
  кінець
  
  якщо вік < 13
    вернути "дитина"
  інакше
    якщо вік < 18
      вернути "підліток"
    інакше
      якщо вік < 65
        вернути "дорослий"
      інакше
        вернути "пенсіонер"
      кінець
    кінець
  кінець
кінець

друк(категорія_віку(-5))   ; помилка: негативний вік
друк(категорія_віку(7))    ; дитина
друк(категорія_віку(15))   ; підліток
друк(категорія_віку(30))   ; дорослий
друк(категорія_віку(70))   ; пенсіонер
```

---

### Тест 5: Калькулятор знижок

```мавка
дія розрахувати_знижку(сума, тип_клієнта)
  якщо тип_клієнта == "VIP"
    вернути сума * 0.7  ; 30% знижка
  кінець
  
  якщо тип_клієнта == "постійний"
    вернути сума * 0.85  ; 15% знижка
  кінець
  
  якщо тип_клієнта == "новий"
    вернути сума * 0.95  ; 5% знижка
  кінець
  
  вернути сума  ; Без знижки для невідомих типів
кінець

друк(розрахувати_знижку(100, "VIP"))        ; 70.0
друк(розрахувати_знижку(100, "постійний"))  ; 85.0
друк(розрахувати_знижку(100, "новий"))      ; 95.0
друк(розрахувати_знижку(100, "гість"))      ; 100.0
```

---

### Тест 6: Визначення типу трикутника

```мавка
дія тип_трикутника(а, б, ц)
  ; Перевірка чи може існувати трикутник
  якщо а + б <= ц
    вернути "не трикутник"
  кінець
  
  якщо а + ц <= б
    вернути "не трикутник"
  кінець
  
  якщо б + ц <= а
    вернути "не трикутник"
  кінець
  
  ; Перевірка типу
  якщо а == б
    якщо б == ц
      вернути "рівносторонній"
    кінець
  кінець
  
  якщо а == б
    вернути "рівнобедрений"
  кінець
  
  якщо б == ц
    вернути "рівнобедрений"
  кінець
  
  якщо а == ц
    вернути "рівнобедрений"
  кінець
  
  вернути "різносторонній"
кінець

друк(тип_трикутника(3, 3, 3))    ; рівносторонній
друк(тип_трикутника(3, 3, 5))    ; рівнобедрений
друк(тип_трикутника(3, 4, 5))    ; різносторонній
друк(тип_трикутника(1, 2, 10))   ; не трикутник
```

---

### Тест 7: Конвертер одиниць температури

```мавка
дія конвертувати_температуру(значення, з_одиниці, в_одиницю)
  якщо з_одиниці == "C"
    якщо в_одиницю == "F"
      вернути значення * 9 / 5 + 32
    кінець
    якщо в_одиницю == "K"
      вернути значення + 273.15
    кінець
    якщо в_одиницю == "C"
      вернути значення
    кінець
  кінець
  
  якщо з_одиниці == "F"
    якщо в_одиницю == "C"
      вернути (значення - 32) * 5 / 9
    кінець
    якщо в_одиницю == "K"
      вернути (значення - 32) * 5 / 9 + 273.15
    кінець
    якщо в_одиницю == "F"
      вернути значення
    кінець
  кінець
  
  вернути "помилка: невідома одиниця"
кінець

друк(конвертувати_температуру(0, "C", "F"))     ; 32.0
друк(конвертувати_температуру(100, "C", "K"))   ; 373.15
друк(конвертувати_температуру(32, "F", "C"))    ; 0.0
друк(конвертувати_температуру(0, "X", "Y"))     ; помилка: невідома одиниця
```

---

## Верифікація

### Крок 1: Демонстрація проблеми

Створіть файл `/tmp/тест_неповні_шляхи.м`:

```мавка
дія класифікувати_число(число)
  якщо число > 10
    вернути "велике"
  кінець
  
  якщо число < 0
    вернути "від'ємне"
  кінець
кінець

друк("Тест 1 (15):")
друк(класифікувати_число(15))

друк("Тест 2 (-5):")
друк(класифікувати_число(-5))

друк("Тест 3 (5):")
результат = класифікувати_число(5)
друк("Результат для 5:")
друк(результат)
```

Запустіть:
```bash
~/мавка /tmp/тест_неповні_шляхи.м
```

**Очікуваний результат:**
```
Тест 1 (15):
велике
Тест 2 (-5):
від'ємне
Тест 3 (5):
Результат для 5:
недійсне
```

☠️ **Функція повертає `недійсне` замість реального значення!**

---

### Крок 2: Виправлення проблеми

Виправте код, додавши завершальне `вернути`:

```мавка
дія класифікувати_число(число)
  якщо число > 10
    вернути "велике"
  кінець
  
  якщо число < 0
    вернути "від'ємне"
  кінець
  
  вернути "нормальне"
кінець

друк("Тест 1 (15):")
друк(класифікувати_число(15))

друк("Тест 2 (-5):")
друк(класифікувати_число(-5))

друк("Тест 3 (5):")
друк(класифікувати_число(5))
```

**Очікуваний результат:**
```
Тест 1 (15):
велике
Тест 2 (-5):
від'ємне
Тест 3 (5):
нормальне
```

✅ **Тепер усі випадки покриті!**

---

### Крок 3: Тест з множинними пропущеними шляхами

Створіть файл `/tmp/тест_сезони.м`:

```мавка
дія знайти_сезон(місяць)
  якщо місяць >= 3
    якщо місяць <= 5
      вернути "весна"
    кінець
  кінець
  
  якщо місяць >= 6
    якщо місяць <= 8
      вернути "літо"
    кінець
  кінець
  
  якщо місяць >= 9
    якщо місяць <= 11
      вернути "осінь"
    кінець
  кінець
  
  вернути "зима"
кінець

друк("Місяць 4:")
друк(знайти_сезон(4))

друк("Місяць 7:")
друк(знайти_сезон(7))

друк("Місяць 10:")
друк(знайти_сезон(10))

друк("Місяць 12:")
друк(знайти_сезон(12))

друк("Місяць 1:")
друк(знайти_сезон(1))
```

**Очікуваний результат:**
```
Місяць 4:
весна
Місяць 7:
літо
Місяць 10:
осінь
Місяць 12:
зима
Місяць 1:
зима
```

✅ **Всі 12 місяців покриті завдяки завершальному `вернути "зима"`**

---

## Резюме

### Проблема
- Мавка **не перевіряє** вичерпність шляхів повернення
- Функції без явного `вернути` мовчки повертають `недійсне`
- Це призводить до **тихих логічних помилок**

### Рішення

✅ **Завжди використовуйте один з цих патернів:**

1. **Завершальне повернення:**
   ```мавка
   дія моя_функція(параметр)
     якщо умова_1
       вернути результат_1
     кінець
     
     якщо умова_2
       вернути результат_2
     кінець
     
     вернути результат_за_замовчуванням  ; ОБОВ'ЯЗКОВО!
   кінець
   ```

2. **Повний ланцюг інакше:**
   ```мавка
   дія моя_функція(параметр)
     якщо умова_1
       вернути результат_1
     інакше
       якщо умова_2
         вернути результат_2
       інакше
         вернути результат_за_замовчуванням  ; ОБОВ'ЯЗКОВО!
       кінець
     кінець
   кінець
   ```

### Золоті правила

1. **Кожна функція повинна мати безумовне `вернути` наприкінці**
2. **Або кожен ланцюг `якщо` повинен закінчуватися на `інакше`**
3. **Завжди тестуйте граничні випадки** — значення, які не попадають в очевидні умови
4. **Не довіряйте мовчанню** — якщо функція не видає помилку, це не означає, що вона працює правильно

### Контрольний список для кожної функції

- [ ] Чи є завершальне `вернути` в кінці функції?
- [ ] Або кожен ланцюг `якщо` закінчується на `інакше`?
- [ ] Чи протестовані всі граничні випадки?
- [ ] Чи немає випадків, коли функція може повернути `недійсне`?

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Попереднє обмеження:** [09. Інші обмеження](./09_інші_обмеження.md)

---

*Документ створено на основі емпіричного тестування інтерпретатора Мавки*  
*Останнє оновлення: 1 січня 2026*
