# Нестабільність ділення (Division Instability)

## Зміст

- [Симптоми](#симптоми)
- [Код, що працює непередбачувано](#код-що-працює-непередбачувано)
- [Чому це відбувається](#чому-це-відбувається)
- [Рішення: захисні перевірки](#рішення-захисні-перевірки)
- [Приклади тестування](#приклади-тестування)
- [Верифікація](#верифікація)
- [Поширені сценарії](#поширені-сценарії)

---

## Симптоми

Операції ділення в Мавці демонструють нестабільну поведінку, особливо у таких випадках:

- **Ділення на нуль** повертає `нескінченність` замість помилки
- **Нескінченність у порівняннях** призводить до непередбачуваних результатів
- **Ділення в складних виразах** може викликати проблеми з приведенням типів
- **Відсутність автоматичних захистів** — програміст має сам перевіряти знаменник

Результат: програма не падає з помилкою, але видає некоректні результати, які важко помітити.

---

## Код, що працює непередбачувано

### Приклад 1: Пряме ділення

```мавка
дія обчислити_швидкість(відстань, час)
  швидкість = відстань / час
  вернути швидкість
кінець

друк(обчислити_швидкість(100, 2))  ; Виведе: 50
друк(обчислити_швидкість(100, 0))  ; Виведе: нескінченність ⚠️
```

**Проблема:** Функція повертає "нескінченність" замість повідомлення про помилку.

---

### Приклад 2: Ділення в умові

```мавка
дія перевірити_ефективність(виконано, витрачено_годин)
  якщо виконано / витрачено_годин > 10
    вернути "відмінно"
  інакше
    вернути "потрібно покращити"
  кінець
кінець

друк(перевірити_ефективність(100, 5))  ; Виведе: відмінно
друк(перевірити_ефективність(100, 0))  ; Виведе: відмінно ⚠️
```

**Проблема:** `нескінченність > 10` повертає `дійсне`, тому функція видає некоректний результат.

---

### Приклад 3: Ділення в поверненні

```мавка
дія обчислити_частку(а, б)
  вернути а / б
кінець

результат = обчислити_частку(50, 0)
друк(результат)  ; Виведе: нескінченність
```

**Проблема:** Повернення "нескінченність" ускладнює подальші обчислення та перевірки.

---

## Чому це відбувається

Мавка **не генерує помилку** при діленні на нуль — замість цього повертається спеціальне значення `нескінченність`.

### Технічні деталі:

1. **Відсутність перевірок на рівні парсера:** Компілятор не вставляє автоматичні захисти від ділення на нуль
2. **Типове приведення:** `нескінченність` веде себе непередбачувано в порівняннях та арифметичних операціях
3. **Тихі помилки:** Програма продовжує працювати з некоректними даними замість того, щоб зупинитися

### Порівняння з іншими мовами:

| Мова | Поведінка при `x / 0` |
| :--- | :--- |
| **Python** | `ZeroDivisionError` (винятка) |
| **JavaScript** | `Infinity` (схоже на Мавку) |
| **Java** | `ArithmeticException` (винятка) |
| **Мавка** | `нескінченність` (без помилки) ⚠️ |

---

## Рішення: захисні перевірки

**Золоте правило:** Завжди перевіряйте знаменник **до** виконання ділення.

### Патерн безпечного ділення

```мавка
дія безпечне_ділення(чисельник, знаменник)
  ; Крок 1: Перевірка знаменника
  якщо знаменник == 0
    вернути "помилка: ділення на нуль"
  кінець
  
  ; Крок 2: Виконання ділення
  результат = чисельник / знаменник
  
  ; Крок 3: Повернення результату
  вернути результат
кінець
```

### Патерн для умов

```мавка
дія перевірити_з_діленням(а, б, межа)
  ; Спочатку перевірка знаменника
  якщо б == 0
    вернути "некоректні дані"
  кінець
  
  ; Потім виконання ділення в окрему змінну
  частка = а / б
  
  ; Нарешті порівняння
  якщо частка > межа
    вернути "високий показник"
  інакше
    вернути "низький показник"
  кінець
кінець
```

---

## Приклади тестування

### Тест 1: Базове ділення

**Неправильно:**
```мавка
дія поділити(а, б)
  вернути а / б
кінець

друк(поділити(10, 2))  ; 5
друк(поділити(10, 0))  ; нескінченність ⚠️
```

**Правильно:**
```мавка
дія поділити(а, б)
  якщо б == 0
    вернути "неможливо поділити"
  інакше
    результат = а / б
    вернути результат
  кінець
кінець

друк(поділити(10, 2))  ; 5
друк(поділити(10, 0))  ; неможливо поділити ✓
```

---

### Тест 2: Ділення у формулі

**Неправильно:**
```мавка
дія обчислити_середнє(сума, кількість)
  середнє = сума / кількість
  вернути середнє
кінець

друк(обчислити_середнє(100, 4))  ; 25
друк(обчислити_середнє(100, 0))  ; нескінченність ⚠️
```

**Правильно:**
```мавка
дія обчислити_середнє(сума, кількість)
  якщо кількість == 0
    вернути "немає даних для обчислення"
  кінець
  
  середнє = сума / кількість
  вернути середнє
кінець

друк(обчислити_середнє(100, 4))  ; 25
друк(обчислити_середнє(100, 0))  ; немає даних для обчислення ✓
```

---

### Тест 3: Ділення в умові

**Неправильно:**
```мавка
дія чи_достатньо_швидкий(кілометри, години, мінімум)
  якщо кілометри / години >= мінімум
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець

друк(чи_достатньо_швидкий(100, 2, 40))  ; так
друк(чи_достатньо_швидкий(100, 0, 40))  ; так ⚠️ (некоректно!)
```

**Правильно:**
```мавка
дія чи_достатньо_швидкий(кілометри, години, мінімум)
  якщо години == 0
    вернути "некоректні дані"
  кінець
  
  швидкість = кілометри / години
  
  якщо швидкість >= мінімум
    вернути "так"
  інакше
    вернути "ні"
  кінець
кінець

друк(чи_достатньо_швидкий(100, 2, 40))  ; так
друк(чи_достатньо_швидкий(100, 0, 40))  ; некоректні дані ✓
```

---

### Тест 4: Кілька ділень підряд

**Неправильно:**
```мавка
дія складна_формула(а, б, ц)
  результат = (а / б) + (б / ц)
  вернути результат
кінець

друк(складна_формула(10, 2, 5))  ; 5.4
друк(складна_формула(10, 0, 5))  ; нескінченність ⚠️
друк(складна_формула(10, 2, 0))  ; нескінченність ⚠️
```

**Правильно:**
```мавка
дія складна_формула(а, б, ц)
  якщо б == 0
    вернути "помилка: б дорівнює нулю"
  кінець
  
  якщо ц == 0
    вернути "помилка: ц дорівнює нулю"
  кінець
  
  перша_частина = а / б
  друга_частина = б / ц
  результат = перша_частина + друга_частина
  
  вернути результат
кінець

друк(складна_формула(10, 2, 5))  ; 5.4
друк(складна_формула(10, 0, 5))  ; помилка: б дорівнює нулю ✓
друк(складна_формула(10, 2, 0))  ; помилка: ц дорівнює нулю ✓
```

---

### Тест 5: Ділення зі від'ємними числами

**Неправильно:**
```мавка
дія обчислити_коефіцієнт(прибуток, витрати)
  коефіцієнт = прибуток / витрати
  
  якщо коефіцієнт > 1
    вернути "прибутково"
  інакше
    вернути "збитково"
  кінець
кінець

друк(обчислити_коефіцієнт(200, 100))   ; прибутково
друк(обчислити_коефіцієнт(100, 0))     ; прибутково ⚠️ (помилка!)
друк(обчислити_коефіцієнт(-100, 50))   ; збитково
```

**Правильно:**
```мавка
дія обчислити_коефіцієнт(прибуток, витрати)
  якщо витрати == 0
    вернути "неможливо обчислити"
  кінець
  
  коефіцієнт = прибуток / витрати
  
  якщо коефіцієнт > 1
    вернути "прибутково"
  інакше
    вернути "збитково"
  кінець
кінець

друк(обчислити_коефіцієнт(200, 100))   ; прибутково
друк(обчислити_коефіцієнт(100, 0))     ; неможливо обчислити ✓
друк(обчислити_коефіцієнт(-100, 50))   ; збитково
```

---

## Верифікація

### Крок 1: Демонстрація проблеми

Створіть файл `/tmp/тест_ділення_проблема.м`:

```мавка
дія небезпечне_ділення(а, б)
  результат = а / б
  вернути результат
кінець

друк(небезпечне_ділення(10, 2))
друк(небезпечне_ділення(100, 0))
друк(небезпечне_ділення(50, 10))
```

Запустіть:
```bash
~/мавка /tmp/тест_ділення_проблема.м
```

**Очікуваний результат:**
```
5
нескінченність
5
```

Бачите? Програма не падає, але повертає `нескінченність` — це і є проблема!

---

### Крок 2: Правильне рішення

Створіть файл `/tmp/тест_ділення_рішення.м`:

```мавка
дія безпечне_ділення(а, б)
  якщо б == 0
    вернути "помилка: ділення на нуль"
  інакше
    результат = а / б
    вернути результат
  кінець
кінець

друк(безпечне_ділення(10, 2))
друк(безпечне_ділення(100, 0))
друк(безпечне_ділення(50, 10))
друк(безпечне_ділення(7, 2))
```

Запустіть:
```bash
~/мавка /tmp/тест_ділення_рішення.м
```

**Очікуваний результат:**
```
5
помилка: ділення на нуль
5
3.5
```

Тепер помилка явна та зрозуміла! ✓

---

### Крок 3: Ділення в умові

Створіть файл `/tmp/тест_ділення_в_умові.м`:

```мавка
дія перевірити_продуктивність(виконано, годин, мета)
  якщо годин == 0
    вернути "некоректні дані"
  кінець
  
  продуктивність = виконано / годин
  
  якщо продуктивність >= мета
    вернути "мета досягнута"
  інакше
    вернути "потрібно працювати краще"
  кінець
кінець

друк(перевірити_продуктивність(100, 10, 8))
друк(перевірити_продуктивність(100, 0, 8))
друк(перевірити_продуктивність(50, 10, 8))
```

**Очікуваний результат:**
```
мета досягнута
некоректні дані
потрібно працювати краще
```

---

### Крок 4: Складна формула

Створіть файл `/tmp/тест_складне_ділення.м`:

```мавка
дія обчислити_індекс(а, б, ц)
  якщо б == 0
    вернути "помилка б"
  кінець
  
  якщо ц == 0
    вернути "помилка ц"
  кінець
  
  частина1 = а / б
  частина2 = частина1 / ц
  
  вернути частина2
кінець

друк(обчислити_індекс(100, 5, 2))
друк(обчислити_індекс(100, 0, 2))
друк(обчислити_індекс(100, 5, 0))
друк(обчислити_індекс(60, 3, 4))
```

**Очікуваний результат:**
```
10
помилка б
помилка ц
5
```

---

## Поширені сценарії

### Сценарій 1: Обчислення середнього значення

```мавка
дія середнє(список)
  якщо список.розмір == 0
    вернути "порожній список"
  кінець
  
  сума = 0
  перебрати список як елемент
    сума = сума + елемент
  кінець
  
  результат = сума / список.розмір
  вернути результат
кінець
```

### Сценарій 2: Обчислення відсотків

```мавка
дія відсоток(частина, ціле)
  якщо ціле == 0
    вернути "неможливо обчислити"
  кінець
  
  результат = частина / ціле
  результат = результат * 100
  
  вернути результат
кінець
```

### Сценарій 3: Перевірка діапазону

```мавка
дія чи_в_межах_норми(значення, норма, допуск)
  якщо норма == 0
    вернути "некоректна норма"
  кінець
  
  відхилення = значення / норма
  
  якщо відхилення >= 1 - допуск
    якщо відхилення <= 1 + допуск
      вернути "в нормі"
    кінець
  кінець
  
  вернути "поза нормою"
кінець
```

---

## Резюме

### Що не працює надійно
- Ділення без перевірки знаменника
- Використання результату ділення безпосередньо в умовах
- Пряме повернення результату ділення без захисту
- Складні формули з кількома діленнями без перевірок

### Що працює надійно
- **Завжди перевіряйте** `знаменник == 0` перед діленням
- **Розділяйте операції:** спочатку ділення, потім порівняння
- **Явні повідомлення про помилки** замість тихого `нескінченність`
- **Кілька перевірок** для складних формул з декількома діленнями

### Золоте правило
**Захисні клаузи — обов'язкові!** Явно перевіряйте `0` або `null` знаменники **до** спроби ділення. Це єдиний надійний спосіб уникнути непередбачуваної поведінки.

### Чек-лист перед кожним діленням
1. ✅ Чи перевірив я знаменник на `0`?
2. ✅ Чи зберіг я результат ділення в окрему змінну?
3. ✅ Чи повертаю я зрозуміле повідомлення про помилку?
4. ✅ Чи протестував я випадок з нульовим знаменником?

---

**Повернутися до:** [Огляд критичних обмежень](./00_огляд.md)

**Наступне обмеження:** [07. Наступна особливість](./07_наступна_особливість.md)

---

*Документ створено на основі емпіричного тестування парсера Мавки версії 0.124.1*  
*Останнє оновлення: 1 січня 2026*
